<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Mirreal Note]]></title>
  <link href="http://blog.mirreal.net/atom.xml" rel="self"/>
  <link href="http://blog.mirreal.net/"/>
  <updated>2017-09-18T22:01:01+08:00</updated>
  <id>http://blog.mirreal.net/</id>
  <author>
    <name><![CDATA[Mirreal Ellison]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[在 Node.js 中使用原生 ES 模块]]></title>
    <link href="http://blog.mirreal.net/blog/2017/09/13/using-es-modules-natively-in-node-dot-js/"/>
    <updated>2017-09-13T16:19:59+08:00</updated>
    <id>http://blog.mirreal.net/blog/2017/09/13/using-es-modules-natively-in-node-dot-js</id>
    <content type="html"><![CDATA[<blockquote><p>原文：<a href="http://2ality.com/2017/09/native-esm-node.html">Using ES modules natively in Node.js</a></p>

<p>作者：<a href="https://twitter.com/rauschma">Axel Rauschmayer</a></p></blockquote>

<p>从版本 8.5.0 开始，Node.js 开始支持原生 ES 模块，可以通过命令行选项打开该功能。新功能很大程度上得归功于 <a href="https://twitter.com/bradleymeck">Bradley Farias</a>。</p>

<h2>1.演示</h2>

<p>这个示例的代码目录结构如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>esm-demo/
</span><span class='line'>    lib.mjs
</span><span class='line'>    main.mjs</span></code></pre></td></tr></table></div></figure>


<p>lib.mjs：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">export</span> <span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>main.mjs：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">add</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;./lib.mjs&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Result: &#39;</span><span class="o">+</span><span class="nx">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行演示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>node --experimental-modules main.mjs
</span><span class='line'>Result: 5
</span></code></pre></td></tr></table></div></figure>


<h2>2.清单：需要注意的事情</h2>

<h3>ES 模块：</h3>

<ul>
<li><p>不能动态导入模块。但是 <a href="http://2ality.com/2017/01/import-operator.html">动态 import()</a> 的相关工作正在进行中，应该很快就能提供支持。</p></li>
<li><p>没有元变量，如 <code>__dirname</code> 和 <code>__filename</code>。但是，有一个的类似功能的提案：“<a href="https://github.com/tc39/proposal-import-meta">import.meta</a>”。看起来可能是这样：</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>现在所有模块标识符都是 URL（这部分在 Node.js 是新增的）：

<ul>
<li>文件 - 带文件扩展名的相对路径： <code>../util/tools.mjs</code></li>
<li>库 - 没有文件扩展名，也没有路径 <code>lodash</code></li>
<li>如何更好地使 npm 库在浏览器中也可用（不使用 bundler）仍有待观察。一种可能性是引入 RequireJS 风格的配置数据，将路径映射到实际路径。目前，在浏览器中使用 bare path 的模块标识符是非法的。</li>
</ul>
</li>
</ul>


<h3>与 CJS 模块的互操作性</h3>

<ul>
<li>你可以导入 CJS 模块，但它们总是只有默认的导出 - 即 <code>module.exports</code> 的值。让 CJS 模块支持命名导出已经在做了，但可能需要一段时间。如果你能帮忙，<a href="https://twitter.com/bradleymeck/status/906210545145184257">可以来做</a>。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="nx">fs1</span> <span class="nx">from</span> <span class="s1">&#39;fs&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">fs1</span><span class="p">).</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// 86</span>
</span><span class='line'>
</span><span class='line'><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">fs2</span> <span class="nx">from</span> <span class="s1">&#39;fs&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">fs2</span><span class="p">));</span> <span class="c1">// [&#39;default&#39;]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>不能在 ES 模块中使用 require()。主要原因是：

<ul>
<li>路径解析工作稍有不同：ESM 不支持 <code>NODE_PATH</code> 和 <code>require.extensions</code>。而且，它的标识符始终是 URL 也会导致一些细微差异。</li>
<li>ES 模块始终以异步方式加载，这确保了与 Web 的最大兼容性。这种加载风格并不能通过 require() 混合使用同步加载 CJS 模块。</li>
<li>禁止同步模块加载也可以为 Top-level await 导入 ES 模块保留后路（一个当前正在考虑的功能）。</li>
</ul>
</li>
</ul>


<h2>3.早期版本的 Node.js 上的 ES 模块</h2>

<p>如果要在 8.5.0 之前的 Node.js 版本上使用 ES 模块，请参阅 John-David Dalton 的 <a href="https://github.com/standard-things/esm">@std/esm</a>。</p>

<p>提示：如果不启用任何可解锁的额外功能，将在 Node.js 保持 100％ 兼容原生 ES 模块.</p>

<h2>FAQ</h2>

<h3>什么时候可以不带命令行选项使用ES 模块？</h3>

<p>目前的计划是在 Node.js 10 LTS 中默认可使用 ES 模块。</p>

<h2>进一步阅读  </h2>

<p>有关 Node.js 和浏览器中 ES 模块的更多信息：</p>

<ul>
<li>“<a href="http://2ality.com/2017/01/babel-esm-spec-mode.html">Making transpiled ES modules more spec-compliant</a>” [using ES modules natively vs. transpiling them via Babel]</li>
<li>“<a href="http://2ality.com/2017/05/es-module-specifiers.html">Module specifiers: what’s new with ES modules?</a>” [Why <code>.mjs</code>? How are module specifiers resolved? Etc.]</li>
<li>“<a href="http://exploringjs.com/es6/ch_modules.html">Modules</a>” [in-depth chapter on ES modules in “Exploring ES6”]</li>
</ul>


<p>即将到来的 ECMAScript 提案：</p>

<ul>
<li>博客: “<a href="http://2ality.com/2017/01/import-operator.html">ES proposal: <code>import()</code> – dynamically importing ES modules</a>”</li>
<li>提案: “<a href="https://github.com/tc39/proposal-import-meta"><code>import.meta</code></a>”</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在工作中学习]]></title>
    <link href="http://blog.mirreal.net/blog/2017/09/02/learning-at-work/"/>
    <updated>2017-09-02T21:49:52+08:00</updated>
    <id>http://blog.mirreal.net/blog/2017/09/02/learning-at-work</id>
    <content type="html"><![CDATA[<blockquote><p>原文；<a href="https://jvns.ca/blog/2017/08/06/learning-at-work/">Learning at work</a></p>

<p>作者：Julia Evans</p>

<p>谈点：学习是一件没有尽头的事，虽然在工作中很多时候被淹没在没玩没了的需求里面，加班是常态，或许很多人不知不觉放弃学习的心思。这篇文章中提到的一些方法我很赞同，很多点也是我的做事方式，这里也希望所有人都能找到适合自己的学习方式。</p></blockquote>

<p>在 Twitter 上我提了一个问题，“你是如何花时间用于自身学习”（<a href="https://twitter.com/b0rk/status/887111177062555648">这个推文</a>)，这些回答有一些相同之处：</p>

<ul>
<li>阅读博客文章</li>
<li>去参加业界大会</li>
<li>读书</li>
<li>在洗碗时看一些演讲</li>
<li>在一些不那么重要的项目里运用你想要学习的技术</li>
</ul>


<p>这些方法都挺管用的。为了个人职业发展，在工作之外花时间学习新技能是非常普遍的事，在这方面我也有不少经验。</p>

<p>另一方面，我知道有一些很厉害的程序员在工作之外完全不写代码。于是我开始思考，如果你想变得更牛，但又不想工作之外花太多额外时间要怎么办？</p>

<p>这些是我以及在 Twitter 上的朋友提到的一些观点，并且都是能在工作时候做的事情。</p>

<h2>不要学习工作之外的编程语言/框架</h2>

<p>这一点听起来有些消极，但确实还是很有用的。对于学习编程语言，我的观点是：</p>

<ul>
<li>我很熟悉几种编程语言（python，scala，ruby）</li>
<li>学习新的编程语言需要相当长的时间</li>
<li>我不想把空闲时间花在上面</li>
</ul>


<p>最近我在做一些 Go 方面的工作，还挺有趣的，我也喜欢做这件事。但是又觉得在上面花费太多个人时间，所以显得不是那么有趣了。通过编写代码学习编程，阅读别人的代码掌握一些模式，然后自己审查代码，然而这些都不是必须的，因为完全可以在工作中去做这些事情。</p>

<h2>选择一些可以从中学习的项目</h2>

<p>这些是我在过去三年学到的一些东西：</p>

<ul>
<li>Scala/Ruby/Go</li>
<li>hadoop/mapreduce/scalding</li>
<li>如何使用 Java 并发库，以及如何配置一个 Java 程序</li>
<li>关于各种 AWS 服务的工作原理</li>
<li>很多机器学习的东西</li>
<li>网络/ CDN / TLS 如何工作</li>
<li>docker/容器/rkt/kubernetes</li>
<li>服务发现 / DNS / jenkins</li>
</ul>


<p>一个关于如何选择项目的例子：如果在工作使用一个不能很好并行的程序，这时候问题就来了。我可以选择去问写这个程序的人为什么不使用并行编程，但是如果我也很想学习一下并行编程的话，就可以自己去完成这件事。所以后来我就 <a href="https://jvns.ca/blog/2016/03/29/thread-pools-part-ii-i-love-blocking/">学到了如何在 Java 中使用线程池</a>。</p>

<p>我只为此工作了几天，但却因此学到了新东西。</p>

<p>现在我正在从事 Kubernetes 相关的工作，当时选择它并不是因为可以在这里面学到很多东西。但是我确实学到很多有关分布式系统的东西，还在工作中使用 Go 语言，我觉得这很很棒。</p>

<p>当人们说像“嘿，我们使用 X 技术，需要有相关经验的人才能在这里工作”时，这其实相当愚蠢。现在我在网络/ puppet / kubernetes / docker / AWS 上花了很多时间，在这项工作之前没有任何相关工作经验。</p>

<h2>观察那些高级人员是如何做事的</h2>

<p>我会观察那些我敬佩的人在工作中的做事方式，然后尝试模仿他们或者是向他们寻求建议。例如，当 <a href="http://onemogin.com/">Cory</a> 加入时，我注意到，在引进新技术的时候，他会这样做：</p>

<ul>
<li>找到另一个有类似问题需要解决的团队</li>
<li>与他们合作，确保技术真正解决问题</li>
</ul>


<p>现在我正在开展一个新项目，一直在考虑这些工作可以帮到谁以及如何帮助，这样做就会感觉好很多。</p>

<h2>阅读每个 pull request</h2>

<p>在这个主题下引用两个我很喜欢的观点：</p>

<blockquote><p>我在一个小团队，所以会阅读所有的 pull request，直到完全了解问题和解决方案</p></blockquote>

<p>和</p>

<blockquote><p>我也是一样！我跟踪检查，看看人们如何解决各种问题</p></blockquote>

<p>事实上，我并没有阅读团队中的每一个 pull request。但是那确实很有用，通过跟踪别人在这方面做的工作来学习这个领域的东西。</p>

<p>但我并不是能完全做到。我曾经从事机器学习方面的工作，发现理论也很有趣，就想跟踪人们在这方面的情况，但对我来说有太多要注意的东西。我只能尽量注意那些比较接近我的东西，像是其中网络团队的一些工作。</p>

<h2>阅读源代码</h2>

<blockquote><p>阅读我用到的源代码对我而言是一个大块头。了解它在内部在做什么，主要是为什么可以通过某种方式工作。</p></blockquote>

<p>这是很重要的一点，也非常重要。很多库、框架、工具并没有很好的文档，在没有阅读源代码的情况下根本无法了解其工作原理。</p>

<h2>跟进你无法解决的 bug</h2>

<p>有时我会遇到一些自己没办法解决的 bug。后来，可能别人会找到解决方法，在这时候，就值得花时间去搞清楚具体的解决方法是什么，以及他们如何想出来的。</p>

<p>例如，最近有一个我没有调试出来的网络问题，刚好有人在上周搞清楚这个问题。现在想一想，大概明白造成这个 bug 的原因，但是我并不清楚他们用什么工具来获取调试所需的信息。当我重新开始工作时，必须确保我真的搞清楚这个问题，这样下次就可以做得更好。</p>

<p>Jessica Kerr 评论道</p>

<blockquote><p>每当我在故障排除时，除了解决这个问题，还会更深入或更广泛地延伸开去。</p></blockquote>

<p>我也喜欢这个回复：</p>

<blockquote><p>有时候，想解决一个与工作有关的问题，但并没有真的在实际工作中发生，只是看看我能不能在某方面有所突破。</p></blockquote>

<h2>运用好通勤时间</h2>

<p>对我而言，其实并没有通勤时间。但很多人提到他们会利用通勤时间来听播客/阅读报纸/阅读有趣的文章。这似乎是一个很不错的方式，来做一些你感兴趣的事情。</p>

<h2>花时间在工作中学习</h2>

<p>Twitter上有人说“我希望每天可以花 1 小时来学习”。我的观点是，我的工作就是要在工作日中抽出时间来学习东西。像现在我正在工作中使用 Kubernetes，这是一个很复杂的系统需要很长时间才能理解，我得花时间了解它是如何工作的。例如，在开始的时候，没什么目的地在做集群测试，只是想了解容器的网络如何工作的，同时也在项目上取得进展。</p>

<p>这可能对我来说挺容易的，因为我的工作跟别人隔得很远，没有人真的知道我具体在做什么，他们只是关心在大方面做的是什么。</p>

<p>实际上，如果要是提前多花点时间阅读，可能效果会更好。就像我刚刚在阅读 Kelsey Hightower 的“learn kubernetes the hard way”的文档，读完不需花太长时间，而且其中有一个关于如何设置一个集群的很好的点，这样就可以很节省我很多时间。</p>

<p>关于这个点，有些人还要想得更远。比如，我的朋友 Dan 就提到好几次，说他喜欢在工作中阅读技术书籍。最初觉得这是一件令人惊讶的事情，但它确实很有用。事实上，有很多跟我工作相关的书籍，找不到理由为什么不能在工作中阅读它们。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JavaScript 中的匿名递归]]></title>
    <link href="http://blog.mirreal.net/blog/2017/08/09/anonymous-recursion-in-javascript/"/>
    <updated>2017-08-09T14:54:22+08:00</updated>
    <id>http://blog.mirreal.net/blog/2017/08/09/anonymous-recursion-in-javascript</id>
    <content type="html"><![CDATA[<blockquote><p>原文：<a href="https://dev.to/simov/anonymous-recursion-in-javascript">Anonymous Recursion in JavaScript</a></p>

<p>作者：Simeon Velichkov</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>    <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>    <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">=&gt;</span>
</span><span class='line'>      <span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">)(</span><span class="nx">l</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>是的，这就是想要分享给大家的一个有趣的示例。这个例子包含以下特性：<a href="https://en.wikipedia.org/wiki/Closure_(computer_programming">闭包</a>)，<a href="https://en.wikipedia.org/wiki/Immediately-invoked_function_expression">自执行函数</a>，<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Functions/Arrow_functions">箭头函数</a>，<a href="https://en.wikipedia.org/wiki/Functional_programming">函数式编程</a> 和 <a href="https://en.wikipedia.org/wiki/Anonymous_recursion">匿名递归</a>。</p>

<p>你可以复制粘贴上述代码到浏览器控制台，会看到打印结果如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">]</span>
</span><span class='line'><span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">]</span>
</span><span class='line'><span class="p">[</span> <span class="mi">3</span> <span class="p">]</span>
</span><span class='line'><span class="p">[]</span>
</span><span class='line'><span class="p">[]</span>
</span><span class='line'><span class="p">[</span> <span class="mi">3</span> <span class="p">]</span>
</span><span class='line'><span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">]</span>
</span><span class='line'><span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>说到函数式编程，这里有一个使用 <a href="https://en.wikipedia.org/wiki/Scheme_(programming_language">Scheme</a>) (JavaScript 借鉴过的其中一门语言)编写的类似例子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>    <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">f</span><span class="p">)</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">f</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">f</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">l</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">print</span> <span class="nv">l</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">null? </span><span class="nv">l</span><span class="p">))</span> <span class="p">((</span><span class="nf">f</span> <span class="nv">f</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">l</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">print</span> <span class="nv">l</span><span class="p">)</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Unwind</h2>

<p>像其他很多编程语言一样，函数调用是通过在函数名称后添加括号 <code>()</code> 来完成的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">foo</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">&#39;hey&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="nx">foo</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 JavaScript 中我们可以使用括号包裹任意数量的表达式：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span><span class="s1">&#39;hey&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;dev.to&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面代码返回结果是 <code>'dev.to'</code>，原因是 JavaScript 返回最后一个表达式作为结果。</p>

<p>使用括号 <code>()</code> 包裹一个匿名函数表示其结果就是 <a href="https://en.wikipedia.org/wiki/Anonymous_function">匿名函数</a> 本身。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">&#39;hey&#39;</span> <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>这本身并没有用处，因为匿名函数没有命名，无法被引用，除非在初始化的时候立即调用它。</p>

<p>就像是普通函数一样，我们可以在其后面添加括号 <code>()</code> 来进行调用。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">&#39;hey&#39;</span> <span class="p">})()</span>
</span></code></pre></td></tr></table></div></figure>


<p>也可以使用箭头函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(()</span> <span class="o">=&gt;</span> <span class="s1">&#39;hey&#39;</span><span class="p">)()</span>
</span></code></pre></td></tr></table></div></figure>


<p>同样地，在匿名函数后添加括号 <code>()</code> 来执行函数，这被称为 <a href="https://en.wikipedia.org/wiki/Immediately-invoked_function_expression">自执行函数</a>。</p>

<h2>闭包</h2>

<p><a href="https://en.wikipedia.org/wiki/Closure_(computer_programming">闭包</a>) 指的是函数和该函数声明词法环境的组合。结合 <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Functions/Arrow_functions">箭头功能</a>，我们可以定义如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hi</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">dev</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">hi</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">dev</span>
</span></code></pre></td></tr></table></div></figure>


<p>在控制台调用上述函数会打印 <code>hey dev.to</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">foo</span><span class="p">(</span><span class="s1">&#39;hey&#39;</span><span class="p">)(</span><span class="s1">&#39;dev.to&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意，我们可以在内部函数作用域访问外部函数的参数 <code>hi</code>。</p>

<p>以下代码跟上述代码一样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">foo</span> <span class="p">(</span><span class="nx">hi</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dev</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">hi</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">dev</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>自执行的版本如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="p">(</span><span class="nx">hi</span><span class="p">)</span> <span class="o">=&gt;</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>      <span class="p">(</span><span class="nx">dev</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">hi</span><span class="p">}</span> <span class="nx">$</span><span class="p">{</span><span class="nx">dev</span><span class="p">}</span><span class="err">`</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="s1">&#39;dev.to&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;hey&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>首先，将 <code>hey</code> 作为参数 <code>hi</code> 的值传给最外层作用域的函数，然后这个函数返回另一个自执行函数。<code>dev.to</code> 作为参数 <code>dev</code> 的值传给内部函数，最后这个函数返回最终值：<code>'hey dev.to'</code>。</p>

<h2>再深入一点</h2>

<p>这个一个上述自执行函数的修改版本：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>    <span class="p">(</span><span class="nx">dev</span><span class="p">)</span> <span class="o">=&gt;</span>
</span><span class='line'>      <span class="p">(</span><span class="nx">hi</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">hi</span><span class="p">}</span> <span class="nx">$</span><span class="p">{</span><span class="nx">dev</span><span class="p">}</span><span class="err">`</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="s1">&#39;dev.to&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="s1">&#39;hey&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>需要注意的是，<a href="https://en.wikipedia.org/wiki/Immediately-invoked_function_expression">自执行函数</a> 和 <a href="https://en.wikipedia.org/wiki/Closure_(computer_programming">闭包</a>) 用作初始化和封装状态，接下来我们来看另外一个例子。</p>

<h2>匿名递归</h2>

<p>回到我们最初的例子，这次加点注释：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>    <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="c1">// 3.</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>    <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="c1">// 2.</span>
</span><span class='line'>      <span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// 4.</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">)(</span><span class="nx">l</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="c1">// 1.</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>输入函数 <code>[1, 2, 3]</code> 传给最外层作用域</li>
<li>整个函数作为参数传给上面函数</li>
<li>这个函数接收下面函数作为参数 <code>f</code> 的值，然后自身调用</li>
<li><code>2.</code>将被调用被作为 <code>3.</code>的结果然后返回函数 <code>4.</code> ，该函数是满足最外层作用域的函数，因此接收输入数组作为 <code>l</code> 参数的值</li>
</ol>


<p>至于结果为什么是那样子，原因是在递归内部有一个对函数 <code>f</code> 的引用来接收输入数组 <code>l</code>。所以能那样调用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">f</span><span class="p">(</span><span class="nx">f</span><span class="p">)(</span><span class="nx">l</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意，<code>f</code> 是一个闭包，所以我们只需要调用它就可以访问到操作输入数组的最里面的函数。</p>

<p>为了说明目的，第一个 <code>console.log(l)</code> 语句表示递归自上而下，第二个语句表示递归自下而上。</p>

<h2>结论</h2>

<p>希望你喜欢这篇文章，并从中学到了新的东西。闭包、自执行函数、函数式编程模式不是黑魔法。它们遵循一套易于理解和玩乐的简单原则。</p>

<p>话虽如此，你必须培养自己何时使用它们，何时不用的这样一种感觉。如果你的代码变得难以维护，那这可能会成为重构中一些好点子。</p>

<p>然而，理解这些基本技术对于创建清晰优雅的解决方案以及提升自我是至关重要的。</p>

<p>Happy Coding！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[面向初学者的高阶组件介绍]]></title>
    <link href="http://blog.mirreal.net/blog/2017/07/19/higher-order-components-for-beginners/"/>
    <updated>2017-07-19T18:59:37+08:00</updated>
    <id>http://blog.mirreal.net/blog/2017/07/19/higher-order-components-for-beginners</id>
    <content type="html"><![CDATA[<blockquote><p>作者：Brandon Newton</p>

<p>原文：<a href="https://btnwtn.com/articles/higher-order-components-for-beginners">Higher-Order Components (HOCs) for Beginners</a></p>

<p>谈点：一篇面向初学者的 HOC 介绍。高阶组件听起来挺唬人的，只看名字恐怕不是那么容易明白究竟是何物，而且通常来讲高阶组件并不是组件，而是接受组件作为参数，并且返回组件的函数。早期利用 ES5 的 mixin 语法来做的事，基本都可以使用高阶组件代替，而且能做的还有更多。</p></blockquote>

<h2>前言</h2>

<p>写这篇文章的起因是其他关于高阶组件（Higher-Order Components）的文章，包含官方文档，都令初学者感到相当困惑。我知道有高阶组件这样一个东西，但不知道它到底有什么用。所以，想通过一篇文章来对高阶组件有一个更好的理解。</p>

<p>在此之前，我们需要先来讲一下 JavaScript 中的函数。</p>

<h2>ES6 箭头函数简介</h2>

<p>接下来将提供一些箭头函数的简单示例，如果之前没有使用过，可以认为它们与普通函数基本一致。下面的代码会展示箭头函数与普通函数的区别。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">42</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// same as:</span>
</span><span class='line'><span class="p">()</span> <span class="o">=&gt;</span> <span class="mi">42</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// same as:</span>
</span><span class='line'><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">42</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">person</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// same as:</span>
</span><span class='line'><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">name</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>阅读 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions">MDN 的箭头函数文档</a> 了解更多信息。</p>

<h2>作为值的函数与部分调用</h2>

<p>就像是数字、字符串、布尔值 一样，函数也是值，意味着可以像传递其他数据一样传递函数，可以将函数作为参数传递给另外一个函数。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">execute</span> <span class="o">=</span> <span class="p">(</span><span class="nx">someFunction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">someFunction</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="nx">execute</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Executed&#39;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>也可以在在函数中返回一个函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">getOne</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="nx">getOne</span><span class="p">()()</span>
</span></code></pre></td></tr></table></div></figure>


<p>之所以在 <code>getOne</code> 后面有两个 <code>()</code> ，是因为第一个返回的返回值是一个函数。如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">getOne</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="nx">getOne</span>
</span><span class='line'><span class="c1">//=&gt; () =&gt; () =&gt; 1</span>
</span><span class='line'>
</span><span class='line'><span class="nx">getOne</span><span class="p">()</span>
</span><span class='line'><span class="c1">//=&gt; () =&gt; 1</span>
</span><span class='line'>
</span><span class='line'><span class="nx">getOne</span><span class="p">()()</span>
</span><span class='line'><span class="c1">//=&gt; 1</span>
</span></code></pre></td></tr></table></div></figure>


<p>从函数返回函数可以帮助我们追踪初始输入函数。例如，下面的函数接受一个数字作为参数，并返回一个将该参数乘以新参数的函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">multiply</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">y</span>
</span><span class='line'>
</span><span class='line'><span class="nx">multiply</span><span class="p">(</span><span class="mi">5</span><span class="p">)(</span><span class="mi">20</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个示例跟上述 <code>getOne</code> 一样，在下面这个例子，让 x = 5，y = 20。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">multiply</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">y</span>
</span><span class='line'>
</span><span class='line'><span class="nx">multiply</span>
</span><span class='line'><span class="c1">//=&gt; (x) =&gt; (y) =&gt; x * y</span>
</span><span class='line'>
</span><span class='line'><span class="nx">multiply</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="c1">//=&gt; (y) =&gt; 5 * y</span>
</span><span class='line'>
</span><span class='line'><span class="nx">multiply</span><span class="p">(</span><span class="mi">5</span><span class="p">)(</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'><span class="c1">//=&gt; 5 * 20</span>
</span></code></pre></td></tr></table></div></figure>


<p>在只传入一个参数调用 <code>multiply</code> 函数时，即部分调用该函数。比如，<code>multiply(5)</code> 讲得到一个将其输入值乘以 5 的函数，<code>multiply(7)</code> 将得到一个将其输入值乘以 7 的函数。依此类推。通过部分调用可以创建一个预定义功能的新函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">multiply</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">y</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">multiplyByFive</span> <span class="o">=</span> <span class="nx">multiply</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">multiplyBy100</span> <span class="o">=</span> <span class="nx">multiply</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">multiplyByFive</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'><span class="c1">//=&gt; 100</span>
</span><span class='line'><span class="nx">multiply</span><span class="p">(</span><span class="mi">5</span><span class="p">)(</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'><span class="c1">//=&gt; 100</span>
</span><span class='line'>
</span><span class='line'><span class="nx">multiplyBy100</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="c1">//=&gt; 500</span>
</span><span class='line'><span class="nx">multiply</span><span class="p">(</span><span class="mi">100</span><span class="p">)(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="c1">//=&gt; 500</span>
</span></code></pre></td></tr></table></div></figure>


<p>一开始看起来似乎没什么用，但是，通过部分调用这种方式可以编写可读性更高，更易于理解的代码。举个例子，可以用一种更清晰的方式来代替 <a href="https://www.styled-components.com/docs/basics#adapting-based-on-props">style-components</a> 的函数插入语法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// before</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">Button</span> <span class="o">=</span> <span class="nx">styled</span><span class="p">.</span><span class="nx">button</span><span class="err">`</span>
</span><span class='line'>  <span class="nx">background</span><span class="o">-</span><span class="nx">color</span><span class="o">:</span> <span class="nx">$</span><span class="p">{({</span> <span class="nx">theme</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">theme</span><span class="p">.</span><span class="nx">bgColor</span><span class="p">}</span>
</span><span class='line'>  <span class="nx">color</span><span class="o">:</span> <span class="nx">$</span><span class="p">{({</span> <span class="nx">theme</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">theme</span><span class="p">.</span><span class="nx">textColor</span><span class="p">}</span>
</span><span class='line'><span class="err">`</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">Button</span> <span class="nx">theme</span><span class="o">=</span><span class="p">{</span><span class="nx">themes</span><span class="p">.</span><span class="nx">primary</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">Submit</span><span class="o">&lt;</span><span class="err">/Button&gt;</span>
</span><span class='line'><span class="c1">// after</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">fromTheme</span> <span class="o">=</span> <span class="p">(</span><span class="nx">prop</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">theme</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">theme</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">Button</span> <span class="o">=</span> <span class="nx">styled</span><span class="p">.</span><span class="nx">button</span><span class="err">`</span>
</span><span class='line'>  <span class="nx">background</span><span class="o">-</span><span class="nx">color</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">fromTheme</span><span class="p">(</span><span class="s2">&quot;bgColor&quot;</span><span class="p">)}</span>
</span><span class='line'>  <span class="nx">color</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">fromTheme</span><span class="p">(</span><span class="s2">&quot;textColor&quot;</span><span class="p">)}</span>
</span><span class='line'><span class="err">`</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">Button</span> <span class="nx">theme</span><span class="o">=</span><span class="p">{</span><span class="nx">themes</span><span class="p">.</span><span class="nx">primary</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">Submit</span><span class="o">&lt;</span><span class="err">/Button&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们创建一个接受一个字符串作为参数的函数 <code>fromTheme("textColor")</code>：它返回一个接受具有 <code>theme</code> 属性的对象的函数：<code>({ theme }) =&gt; theme[prop]</code>，然后再通过初始传入的字符串 <code>"textColor"</code> 进行查找。我们可以做得更多，写类似的 <code>backgroundColor</code> 和 <code>textColor</code> 这种部分调用 <code>fromTheme</code> 的函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">fromTheme</span> <span class="o">=</span> <span class="p">(</span><span class="nx">prop</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">theme</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">theme</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">backgroundColor</span> <span class="o">=</span> <span class="nx">fromTheme</span><span class="p">(</span><span class="s2">&quot;bgColor&quot;</span><span class="p">)</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">textColor</span> <span class="o">=</span> <span class="nx">fromTheme</span><span class="p">(</span><span class="s2">&quot;textColor&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">Button</span> <span class="o">=</span> <span class="nx">styled</span><span class="p">.</span><span class="nx">button</span><span class="err">`</span>
</span><span class='line'>  <span class="nx">background</span><span class="o">-</span><span class="nx">color</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">backgroundColor</span><span class="p">}</span>
</span><span class='line'>  <span class="nx">color</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">textColor</span><span class="p">}</span>
</span><span class='line'><span class="err">`</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">Button</span> <span class="nx">theme</span><span class="o">=</span><span class="p">{</span><span class="nx">themes</span><span class="p">.</span><span class="nx">primary</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">Submit</span><span class="o">&lt;</span><span class="err">/Button&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>高阶函数</h2>

<p>高阶函数的定义是，接受函数作为参数的函数。如果曾经使用过类似 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map">map</a> 这样的函数，可能已经很熟悉高阶函数。如果不熟悉 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map">map</a>，它是一个数组遍历的方法，接受一个函数作为参数应用到数组中的每个元素。例如，可以像这样对一个数组作平方：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">square</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">square</span><span class="p">)</span>
</span><span class='line'><span class="c1">//=&gt; [ 1, 4, 9 ]</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以实现一个我们自己的 <code>map</code> 版本来说明这个概念：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">array</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">mappedArray</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">mappedArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
</span><span class='line'>      <span class="c1">// apply fn with the current element of the array</span>
</span><span class='line'>      <span class="nx">fn</span><span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">mappedArray</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后再使用我们的 map 版本来对一个数组作平方：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">square</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">map</span><span class="p">(</span><span class="nx">square</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]))</span>
</span><span class='line'><span class="c1">//=&gt; [ 1, 4, 9, 16, 25 ]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>译者注：我们也可以将 map 方法从对象中解耦出来：</p>

<pre><code class="javascript">const map = (fn, array) =&gt; Array.prototype.map.call(array, fn)
</code></pre>

<p>这样也可以像上述例子一样调用。
或者更函数式的做法，再来点柯里化：</p>

<pre><code class="javascript">const map = array =&gt; fn =&gt; Array.prototype.map.call(array, fn)
</code></pre></blockquote>

<p>或者是返回一个 <code>&lt;li&gt;</code>的 React 元素数组：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">HeroList</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">heroes</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">(</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="nx">map</span><span class="p">((</span><span class="nx">hero</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">hero</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">hero</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/li&gt;</span>
</span><span class='line'>    <span class="p">),</span> <span class="nx">heroes</span><span class="p">)}</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">/ul&gt;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">HeroList</span> <span class="nx">heroes</span><span class="o">=</span><span class="p">[</span>
</span><span class='line'>  <span class="s2">&quot;Wonder Woman&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;Black Widow&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;Spider Man&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;Storm&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;Deadpool&quot;</span>
</span><span class='line'><span class="p">]</span><span class="o">/&gt;</span>
</span><span class='line'><span class="cm">/*=&gt; (</span>
</span><span class='line'><span class="cm">  &lt;ul&gt;</span>
</span><span class='line'><span class="cm">    &lt;li&gt;Wonder Woman&lt;/li&gt;</span>
</span><span class='line'><span class="cm">    &lt;li&gt;Black Widow&lt;/li&gt;</span>
</span><span class='line'><span class="cm">    &lt;li&gt;Spider Man&lt;/li&gt;</span>
</span><span class='line'><span class="cm">    &lt;li&gt;Storm&lt;/li&gt;</span>
</span><span class='line'><span class="cm">    &lt;li&gt;Deadpool&lt;/li&gt;</span>
</span><span class='line'><span class="cm">  &lt;/ul&gt;</span>
</span><span class='line'><span class="cm">)*/</span>
</span></code></pre></td></tr></table></div></figure>


<h2>高阶组件</h2>

<p>我们知道，高阶函数是接受函数作为参数的函数。在 React 中，任何返回 <a href="https://facebook.github.io/react/docs/jsx-in-depth.html">JSX</a> 的函数都被称为无状态函数组件，简称为函数组件。基本的函数组件如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">Title</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">Title</span><span class="o">&gt;</span><span class="nx">Higher</span><span class="o">-</span><span class="nx">Order</span> <span class="nx">Components</span><span class="p">(</span><span class="nx">HOCs</span><span class="p">)</span> <span class="k">for</span> <span class="nx">React</span> <span class="nx">Newbies</span><span class="o">&lt;</span><span class="err">/Title&gt;</span>
</span><span class='line'><span class="c1">//=&gt; &lt;h1&gt;Higher-Order Components(HOCs) for React Newbies&lt;/h1&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>高阶组件则是<em>接受组件作为参数并返回组件的函数</em>。如何使用传入组件完全取决于你，甚至可以完全忽视它：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Technically an HOC</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">ignore</span> <span class="o">=</span> <span class="p">(</span><span class="nx">anything</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;:</span><span class="p">)</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">IgnoreHeroList</span> <span class="o">=</span> <span class="nx">ignore</span><span class="p">(</span><span class="nx">HeroList</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">IgnoreHeroList</span> <span class="o">/&gt;</span>
</span><span class='line'><span class="c1">//=&gt; &lt;h1&gt;:)&lt;/h1&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以编写一个将输入转换成大写的 HOC：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">yell</span> <span class="o">=</span> <span class="p">(</span><span class="nx">PassedComponent</span><span class="p">)</span> <span class="o">=&gt;</span>
</span><span class='line'>  <span class="p">({</span> <span class="nx">children</span><span class="p">,</span> <span class="p">...</span><span class="nx">props</span> <span class="p">})</span> <span class="o">=&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">PassedComponent</span> <span class="p">{...</span><span class="nx">props</span><span class="p">}</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="p">{</span><span class="nx">children</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()}</span><span class="o">!</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="err">/PassedComponent&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">Title</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AngryTitle</span> <span class="o">=</span> <span class="nx">yell</span><span class="p">(</span><span class="nx">Title</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">AngryTitle</span><span class="o">&gt;</span><span class="nx">Whatever</span><span class="o">&lt;</span><span class="err">/AngryTitle&gt;</span>
</span><span class='line'><span class="c1">//=&gt; &lt;h1&gt;WHATEVER!&lt;/h1&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>你也可以返回一个有状态组件，因为 JavaScript 中的类不过是函数的语法糖。这样就可以使用到 React 生命周期的方法，比如 <code>componentDidMount</code>。这是 HOCs 真正有用的地方。我们现在可以做一些稍微有趣点的事，比如将 HTTP 请求的结果传递给函数组件。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">withGists</span> <span class="o">=</span> <span class="p">(</span><span class="nx">PassedComponent</span><span class="p">)</span> <span class="o">=&gt;</span>
</span><span class='line'>  <span class="kr">class</span> <span class="nx">WithGists</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">gists</span><span class="o">:</span> <span class="p">[]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fetch</span><span class="p">(</span><span class="s2">&quot;https://api.github.com/gists/public&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">gists</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">gists</span><span class="o">:</span> <span class="nx">gists</span>
</span><span class='line'>      <span class="p">}))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">PassedComponent</span>
</span><span class='line'>          <span class="p">{...</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">}</span>
</span><span class='line'>          <span class="nx">gists</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">gists</span><span class="p">}</span>
</span><span class='line'>        <span class="o">/&gt;</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">Gists</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">gists</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">(</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">gists</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">)}</span><span class="o">&lt;</span><span class="err">/pre&gt;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">GistsList</span> <span class="o">=</span> <span class="nx">withGists</span><span class="p">(</span><span class="nx">Gists</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">GistsList</span> <span class="o">/&gt;</span>
</span><span class='line'><span class="c1">//=&gt; Before api request finishes:</span>
</span><span class='line'><span class="c1">// &lt;Gists gists={[]} /&gt;</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//=&gt; After api request finishes:</span>
</span><span class='line'><span class="c1">// &lt;Gists gists={[</span>
</span><span class='line'><span class="c1">//  { /* … */ },</span>
</span><span class='line'><span class="c1">//  { /* … */ },</span>
</span><span class='line'><span class="c1">//  { /* … */ }</span>
</span><span class='line'><span class="c1">// ]} /&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>withGists</code> 会传递 gist api 调用的结果，并且你可以在任何组件上使用。<a href="https://codesandbox.io/embed/o2YpJnpDj">点击这里</a> 可以看到一个更加完整的例子。</p>

<h2>结论：高阶组件是 🔥🔥🔥</h2>

<p>react-redux 也是使用 HOC， <a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#connectmapstatetoprops-mapdispatchtoprops-mergeprops-options">connect</a> 将应用 store 的值传递到“已连接” 的组件。它还会执行一些错误检查和组件生命周期优化，如果手动完成将导致编写大量重复代码。</p>

<p>如果你发现自己在不同地方编写了大量的代码，那么也可以将代码重构成可重用的 HOC。</p>

<p>HOCs 非常具有表现力，可以使用它们创造很多很酷的东西。</p>

<p>尽可能地保持你的 HOC 简单，<em>不要编写需要阅读长篇大论才能理解的代码</em>。</p>

<h3>附加练习</h3>

<p>下面有一些练习，来巩固对 HOC 的理解：</p>

<ul>
<li>写一个反转其输入的 HOC</li>
<li>编写一个HOC，将 API 中的数据提供给组件</li>
<li>写一个HOC来实现 <a href="https://facebook.github.io/react/docs/react-component.html#shouldcomponentupdate"><code>shouldComponentUpdate</code></a>，<a href="https://facebook.github.io/react/docs/optimizing-performance.html#avoid-reconciliation">以避免更新</a>。</li>
<li>编写一个 HOC，使用 <a href="https://facebook.github.io/react/docs/react-api.html#react.children.toarray"><code>React.Children.toArray</code></a> 对传入组件子元素进行排序。</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CSS Animations vs Web Animations API]]></title>
    <link href="http://blog.mirreal.net/blog/2017/06/26/css-animations-vs-web-animations-api-slash/"/>
    <updated>2017-06-26T20:47:08+08:00</updated>
    <id>http://blog.mirreal.net/blog/2017/06/26/css-animations-vs-web-animations-api-slash</id>
    <content type="html"><![CDATA[<blockquote><p>作者：Ollie Williams</p>

<p>原文：<a href="https://css-tricks.com/css-animations-vs-web-animations-api/">CSS Animations vs Web Animations API</a></p></blockquote>

<p>在  JavaScript 有一个原生动画 API 叫 Web Animations API，在这篇文章中简称为 WAAPI。MDN 上已经有 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Animations_API">很好的文档</a>，而且，Dan Wilson 为此写了 <a href="http://danielcwilson.com/blog/2015/07/animations-part-1/">一个很棒的文章系列</a>。</p>

<p>在本文中，我们一起来对比一下 WAAPI 和 CSS 动画。</p>

<h2>关于浏览器支持</h2>

<p>尽管浏览器原生支持仍然有限，但 WAAPI 有一个全面和强大的 <a href="https://github.com/web-animations/web-animations-js">polyfill</a>，使得现在就能在生产环境使用。</p>

<p>同样地，可以在 <a href="https://github.com/web-animations/web-animations-js">Can I Use</a> 查看浏览器兼容性数据。然而，这并没有提供很好的信息来支持 WAAPI 的所有子功能。这里有一个检查工具：</p>

<p>See the Pen <a href="https://codepen.io/danwilson/pen/xGBKVq/">WAAPI Browser Support Test</a> by Dan Wilson (<a href="https://codepen.io/danwilson">@danwilson</a>) on <a href="https://codepen.io/">CodePen</a>.</p>

<p>要想再没有 polyfill 的情况下体验所有功能，请使用 Firefox Nightly。</p>

<h2>WAAPI 的基础知识</h2>

<p>如果你曾经使用 jQuery  的 <code>.animate()</code>，那么应该会觉得 WAAPI 的基本语法看起来很熟悉。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.animate-me&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">element</span><span class="p">.</span><span class="nx">animate</span><span class="p">(</span><span class="nx">keyframes</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>animate</code> 方法接受两个参数：关键帧和持续时间。与 jQuery 相比的优势是，不仅是浏览器内置，而且性能也更好。</p>

<p>第一个参数，关键帧，是一个对象数组，每个对象都是动画中的一个关键帧。看这个简单的例子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">keyframes</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>  <span class="p">{</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class='line'><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>第二个参数，持续时间，指的是想要动画持续多久，在上面的例子中是 1000 毫秒。接下来看一个更令人兴奋的例子。</p>

<h2>用 WAAPI 重新创建一个 animista 的 CSS 动画</h2>

<p>这里有一些从 <a href="http://animista.net/">animista</a> 拉取的 CSS 代码，被称为 slide-in-blurred-top 的入场动画。看起来很漂亮</p>

<p>在 <a href="http://animista.net/play/entrances/slide-in-blurred/slide-in-blurred-top">实际PERF</a> 比这个 GIF 效果好很多。</p>

<p>以下是 CSS 中的关键帧：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">0</span><span class="o">%</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">transform</span><span class="o">:</span> <span class="n">translateY</span><span class="p">(</span><span class="m">-1000px</span><span class="p">)</span> <span class="n">scaleY</span><span class="p">(</span><span class="m">2</span><span class="o">.</span><span class="m">5</span><span class="p">)</span> <span class="n">scaleX</span><span class="p">(</span><span class="o">.</span><span class="m">2</span><span class="p">);</span>
</span><span class='line'>  <span class="n">transform</span><span class="o">-</span><span class="n">origin</span><span class="o">:</span> <span class="m">50%</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">filter</span><span class="o">:</span> <span class="n">blur</span><span class="p">(</span><span class="m">40px</span><span class="p">);</span>
</span><span class='line'>  <span class="k">opacity</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nt">100</span><span class="o">%</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">transform</span><span class="o">:</span> <span class="n">translateY</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="n">scaleY</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="n">scaleX</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</span><span class='line'>  <span class="n">transform</span><span class="o">-</span><span class="n">origin</span><span class="o">:</span> <span class="m">50%</span> <span class="m">50%</span><span class="p">;</span>
</span><span class='line'>  <span class="n">filter</span><span class="o">:</span> <span class="n">blur</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
</span><span class='line'>  <span class="k">opacity</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 WAAPI 中代码基本相同：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">keyframes</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nx">transform</span><span class="o">:</span> <span class="s1">&#39;translateY(-1000px) scaleY(2.5) scaleX(.2)&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">transformOrigin</span><span class="o">:</span> <span class="s1">&#39;50% 0&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">filter</span><span class="o">:</span> <span class="s1">&#39;blur(40px)&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">opacity</span><span class="o">:</span> <span class="mi">0</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nx">transform</span><span class="o">:</span> <span class="s1">&#39;translateY(0) scaleY(1) scaleX(1)&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">transformOrigin</span><span class="o">:</span> <span class="s1">&#39;50% 50%&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">filter</span><span class="o">:</span> <span class="s1">&#39;blur(0)&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">opacity</span><span class="o">:</span> <span class="mi">1</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看出，将关键帧应用到需要动画的元素上是多么容易：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">element</span><span class="p">.</span><span class="nx">animate</span><span class="p">(</span><span class="nx">keyframes</span><span class="p">,</span> <span class="mi">700</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>为了简单起见，只指定了持续时间。但是，我们可以使用这个第二个参数来传递更多的选项，至少也应该指定一个缓动效果。以下是所有可用选项的完整列表，其中包含一些示例值：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">iterations</span><span class="o">:</span> <span class="kc">Infinity</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">iterationStart</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">delay</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">endDelay</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">direction</span><span class="o">:</span> <span class="s1">&#39;alternate&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">duration</span><span class="o">:</span> <span class="mi">700</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">fill</span><span class="o">:</span> <span class="s1">&#39;forwards&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">easing</span><span class="o">:</span> <span class="s1">&#39;ease-out&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">element</span><span class="p">.</span><span class="nx">animate</span><span class="p">(</span><span class="nx">keyframes</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>加上这些选项，我们的动画将从头开始，没有任何延迟，在动画完成后往返循环播放。</p>

<p>不爽的是，对于熟悉 CSS 动画的人来说，一些术语跟我们习惯的有所不同。好处是打字会更快一些！</p>

<ul>
<li>使用 <code>easing</code> 而不是 <code>animation-timing-function</code></li>
<li>不是 <code>animation-iteration-count</code>，而是 <code>iterations</code>。如果我们希望动画永远重复，使用 <code>Infinity</code> 而不是 <code>infinite</code>。有点混乱， <code>Infinity</code> 不带引号。<code>Infinity</code> 是一个 JavaScript 关键字，而其他值都是字符串。</li>
<li>我们使用毫秒而不是秒，对于之前写过许多 JavaScript 的人来说，这应该是一样的。（你也可以在 CSS 动画中使用毫秒数，但很少有人使用。）</li>
</ul>


<p>我们来仔细看看一个选项：<code>iterationStart</code>。</p>

<p>当我第一次碰到 <code>iterationStart</code> 有点困惑。为什么要从指定的迭代开始，而不是只要减少迭代次数？当使用十进制数时，此选项非常有用。例如，可以将其设置为  <code>.5</code>，动画将开始一半。要做一个完整的动画需要两个一半，所以如果迭代次数设置为 1，并且将 <code>iterationStart</code> 设置为  <code>.5</code>，动画将从一半到动画结束播放，然后从动画开头开始，结束于中间！</p>

<p>值得注意的是，也可以将迭代次数设置为小于 1。例如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">option</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">iterations</span><span class="o">:</span> <span class="p">.</span><span class="mi">5</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">iterationStart</span><span class="o">:</span> <span class="p">.</span><span class="mi">5</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样，动画会从中间开始，一直播放到最后。</p>

<p>endDelay：如果要将多个动画串在一起，但是希望在一个动画的结尾和后续动画的开始之间存在差距，这时 endDelay 就很有用。这是一个有用的视频，由 Patrick Brosset 来解释。</p>

<p><a href="https://www.youtube.com/embed/hWe-qukNrN8">一个 YouTube 的视频</a></p>

<h2>缓动（easing）</h2>

<p>在任何动画中，缓动都是最重要的元素之一。WAAPI 为我们提供了两种不同的方式设置缓动 - 在我们的关键帧数组或我们的选项对象内。</p>

<p>在 CSS 中，如果使用 <code>animation-timing-function: ease-in-out</code> 你可能会认为动画会缓慢开始，然后缓慢结束。实际上，这些缓动应用在关键帧之间，而不是整个动画。这可以对动画的感觉进行细粒度的控制。WAAPI 也提供这种功能。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">keyframes</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>  <span class="p">{</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">easing</span><span class="o">:</span> <span class="s1">&#39;ease-in&#39;</span> <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nx">easing</span><span class="o">:</span> <span class="s1">&#39;ease-out&#39;</span> <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>值得注意的是，在 CSS 和 WAAPI 中，不应该传入最后一帧的缓动值，因为这将不起作用。可是很多人会犯这种错误。</p>

<p>有时候，在整个动画中添加缓动效果更为直观。这在 CSS 是不可能的，但现在可以在 WAAPI 中实现。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">duration</span><span class="o">:</span> <span class="mi">1000</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">easing</span><span class="o">:</span> <span class="s1">&#39;ease-in-out&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到这两种缓动在 CodePen 上的区别：</p>

<p><a href="https://codepen.io/cssgrid/pen/OmrVeQ">点我查看</a></p>

<h2>缓动 vs 线性</h2>

<p>值得注意的是 CSS 动画和 WAAPI 之间的另一个区别：<strong>在 CSS 中 默认值是 ease，而在 WAAPI 默认是 linear。</strong> ease 实际上是 <code>ease-in-out</code> 的一个版本，当你想偷懒时这是一个非常好的选择。同时，线性代表致命的沉闷和无生命 - 一致的速度看起来机械和不自然。它被选为默认值，可能因为它是最中立的选项。然而，在使用 WAAPI 时，更好是使用缓动，以免动画看起来很乏味和机械。</p>

<h2>性能</h2>

<p>WAAPI 提供与 CSS 动画相同的性能改进，尽管这并不意味着一定就是平滑的动画。</p>

<p>希望这个 API 的性能优化做到，使我们可以避免使用 <code>will-change</code>和 <code>translateZ</code> 成为可能。但是，至少在目前的浏览器实现中，这些属性在处理性能问题方面仍然是有帮助，有必要的。</p>

<p>但是，如果你的动画有延迟，则无需担心使用 <code>will-change</code>。web animations 规范的主要作者对 <a href="https://damp-lake-50659.herokuapp.com/">Animation for Work Slack community</a> 提出了一些有趣的建议，希望他不介意我在这里重复：</p>

<blockquote><p>如果有一个正向的延迟，不需要使用 <code>will-change</code>，因为浏览器将在延迟开始时进行分层，当动画启动时，它将准备就绪。</p></blockquote>

<h2>WAAPI 对战 CSS 动画？</h2>

<p>WAAPI 为我们提供了一套已经在 CSS 中实现的 JavaScript 语法。然而，它们不应该被视为对手。如果我们坚持使用 CSS 完成动画和转换，那么我们可以在 WAAPI 进行动画交互。</p>

<h2>动画对象</h2>

<p><code>.animate()</code> 方法不仅处理元素的动画，它也返回一些东西。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">myAnimation</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">animate</span><span class="p">(</span><span class="nx">keyframes</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>在控制台中查看的动画对象</p>

<p>如果我们在控制台中查看返回值，会发现这是一个动画对象。这为我们提供了各种各样的功能，其中一些是不言自明，比如 <code>myAnimation.pause()</code>。通过更改 <code>animation-play-state</code> 属性，我们可以通过 CSS 动画实现类似的结果，但 WAAPI 语法比 <code>element.style.animationPlayState = "paused"</code> 更简洁。我们也可以通过 <code>myAnimation.reverse()</code> 轻松反转动画，同样地，跟我们使用脚本更改 CSS 的 <code>animation-direction</code> 属性相比，稍微有点进步。</p>

<p>然而，到目前为止，使用 JavaScript 操作 <code>@keyframe</code> 并不是件容易的的事。即使是重新启动动画这样简单的事，也是需要一些技巧的，就像 Chris Coyier <a href="https://css-tricks.com/restart-css-animation/">先前写过的那样</a>。使用 WAAPI，我们可以简单地使用 <code>myAnimation.play()</code> ，如果动画已经完成，将从一开始就重播动画，或者如果我们暂停播放，则从中间迭代播放动画。</p>

<p>我们甚至可以轻松地改变动画的速度。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">myAnimation</span><span class="p">.</span><span class="nx">playbackRate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// speed it up</span>
</span><span class='line'><span class="nx">myAnimation</span><span class="p">.</span><span class="nx">playbackRate</span> <span class="o">=</span> <span class="p">.</span><span class="mi">4</span><span class="p">;</span> <span class="c1">// use a number less than one to slow it down</span>
</span></code></pre></td></tr></table></div></figure>


<h2>getAnimations()</h2>

<p>这个方法将返回所有动画对象的数组，包含使用 WAAPI 定义的动画和 CSS 转换或动画。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">element</span><span class="p">.</span><span class="nx">getAnimations</span><span class="p">()</span> <span class="c1">// returns any animations or transitions applied to our element using  CSS or WAAPI</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果你喜欢使用 CSS 来定义和使用动画，<code>getAnimations()</code>  允许 API​​ 与 <code>@keyframes</code> 结合使用。你可以继续使用 CSS 进行大部分动画工作，然后在需要 API 时获得使用 API 的优势。</p>

<p>即使一个 DOM 元素只使用到一个动画，<code>getAnimations()</code> 也将始终返回一个数组。我们使用那个单一的动画对象来处理。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">h2</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;h2&quot;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">myCSSAnimation</span> <span class="o">=</span> <span class="nx">h2</span><span class="p">.</span><span class="nx">getAnimations</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们也可以在 CSS 动画中使用 web animation API :)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">myCSSAnimation</span><span class="p">.</span><span class="nx">playbackRate</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span><span class='line'><span class="nx">myCSSAnimation</span><span class="p">.</span><span class="nx">reverse</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Promise 和 Event</h2>

<p>很多通过 CSS 触发的事件，现在我们已经可以使用 JavaScript 代码来完成：   <code>animationstart</code>，<code>animationend</code>，<code>animationiteration</code> 和 <code>transitionend</code>。之前经常需要监听动画或转换的结束，以便从 DOM 中删除应用的元素。</p>

<p>在动画对象可以使用 WAAPI 来完成 <code>animationend</code> 或 <code>transitionend</code> 做的事情：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">myAnimation</span><span class="p">.</span><span class="nx">onfinish</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">element</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>WAAPI 为我们提供了两个选择：event 和 promise。动画对象的 <code>.finished</code> 方法会返回一个在动画结束时的 promise。下面这段代码是上面例子的 promise 版本：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">myAnimation</span><span class="p">.</span><span class="nx">finished</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span>
</span><span class='line'>  <span class="nx">element</span><span class="p">.</span><span class="nx">remove</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们来看看来自 Mozilla 开发者网络中的一个稍微复杂点的例子。<code>Promise.all</code> 接受一个 promise 的数组，一旦所有 promise 完成才会运行回调函数。可以看出，<code>element.getAnimations()</code> 返回的是一个动画对象数组。我们可以将数组中的所有动画对象 map 到每个动画对象的 <code>.finished</code>上，这样就获得需要的 promise 数组。</p>

<p>在这个例子中，只有在页面上的所有动画完成后，我们的函数才能运行。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getAnimations</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">animation</span> <span class="o">=&gt;</span>
</span><span class='line'>  <span class="nx">animation</span><span class="p">.</span><span class="nx">finished</span><span class="p">)).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// do something cool</span>
</span><span class='line'>  <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h2>未来</h2>

<p>本文中提到的功能只是一个开始。从目前的规范和实施来看，未来会有一个很强大动画 API。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JavaScript 异常的防范与监控]]></title>
    <link href="http://blog.mirreal.net/blog/2017/06/21/javascript-stack-trace/"/>
    <updated>2017-06-21T23:12:00+08:00</updated>
    <id>http://blog.mirreal.net/blog/2017/06/21/javascript-stack-trace</id>
    <content type="html"><![CDATA[<p>一套完善的前端体系应少不了异常统计与监控，即使有足够的质量保证体系，难免会出现一些意料之外的事，尤其是在复杂的网路环境和运行环境之下。为了保证代码的健壮性以及页面的稳定性，我们从多个方面来做异常的防范和监控。</p>

<h2>三种思路</h2>

<h3>主动防御</h3>

<p>对于我们操作的数据，尤其是由 API 接口返回的，时常会有一个很复杂的深层嵌套的数据结构。为了代码的健壮性，很多时候需要对每一层访问都作空值判断，就像这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">props</span><span class="p">.</span><span class="nx">user</span> <span class="o">&amp;&amp;</span>
</span><span class='line'><span class="nx">props</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">posts</span> <span class="o">&amp;&amp;</span>
</span><span class='line'><span class="nx">props</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">posts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
</span><span class='line'><span class="nx">props</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">posts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">comments</span> <span class="o">&amp;&amp;</span>
</span><span class='line'><span class="nx">props</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">posts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>类似的代码大家可能都写过，没写过大概也见到别人写过。看起来确实相当地不美观，有句话说得很棒：</p>

<p><strong>The opposite of beautiful is not ugly, but wrong.</strong></p>

<p>我们得找到一种，更简单、更优雅、更安全的方式来处理这种情形。参考这篇文章：<a href="https://medium.com/javascript-inside/safely-accessing-deeply-nested-values-in-javascript-99bf72a0855a">Safely Accessing Deeply Nested Values In JavaScript</a>，文章提到借助 Ramda、Lenses、Lodash 以及 Immutable.js 等类库的方式，并提供一个非常简洁明了的原生解决方案：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">getIn</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">xs</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="nx">xs</span> <span class="o">&amp;&amp;</span> <span class="nx">xs</span><span class="p">[</span><span class="nx">x</span><span class="p">])</span> <span class="o">?</span> <span class="nx">xs</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">},</span> <span class="nx">o</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来我们这样访问就可以了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">getIn</span><span class="p">([</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span><span class="p">],</span> <span class="nx">props</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果正常访问到，则返回对应的值，否则返回 <code>null</code>。</p>

<p>这里提供的只是主动防御的一种情形，关于如何编写更安全的代码这里不作深入展开。</p>

<h3>全局监控</h3>

<p>浏览器提供 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/GlobalEventHandlers/onerror"><code>window.onerror</code></a> API 来帮助我们进行全局的错误监控：</p>

<ul>
<li>当 JavaScript 运行时错误（包括语法错误）发生时，会执行 `window.onerror()&#8220;</li>
<li>当一项资源（如 <code>&lt;img&gt;</code> 或 <code>&lt;script&gt;</code> ）加载失败，能被单一的 <code>window.addEventListener</code> 捕获</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * @param  {String} message 错误信息</span>
</span><span class='line'><span class="cm"> * @param  {String} source  发生错误的脚本URL</span>
</span><span class='line'><span class="cm"> * @param  {Number} lineno  发生错误的行号</span>
</span><span class='line'><span class="cm"> * @param  {Number} colno   发生错误的列号</span>
</span><span class='line'><span class="cm"> * @param  {Object} error   Error对象</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">lineno</span><span class="p">,</span> <span class="nx">colno</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中 error 对象包含详细的错误堆栈信息，在 IE9 以前，没有这个参数。</p>

<h3>针对性捕获 try..catch</h3>

<p>可以通过 try..catch 来主动抓取错误，想要对一段代码 try..catch，我们可以这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">try</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">handler</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>对一个函数做 try..catch 封装:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">tryify</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">handleError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">throw</span> <span class="nx">error</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>为什么是 script error</h2>

<p>方案已经明确，但还有一些问题。在查看 JavaScript 错误统计时，发现 80% 以上都是 &ldquo;script error&#8221;。原来，当加载自不同域的脚本中发生语法错误时，为避免信息泄露，语法错误的细节将不会报告，而代之简单的 &#8220;Script error.&rdquo;</p>

<p>而在大多数情况下，我们的静态资源放在专门的 CDN 服务器上，跟站点并不在一个域，所以如果只是简单的抓取，只会得到一堆意义不大的 <code>script error</code></p>

<p>解决方案：</p>

<ul>
<li>添加 CORS 支持</li>
<li>使用 try..catch</li>
</ul>


<h3>添加 CORS 支持</h3>

<p>需要做两点：</p>

<p>1.在 script 便签添加 crossorigin，默认值 <code>crossorigin="anonymous"</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;//xxx.com/example.js&quot;</span> <span class="na">crossorigin</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 require.js 里提供一个 <a href="https://github.com/requirejs/requirejs/blob/e97fe4dd894d8a07712156e17cefa28b954a9c3e/require.js#L1946">onNodeCreated hook</a>，供我们提供扩展，要添加 crossorigin 属性，如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script&gt;</span>
</span><span class='line'><span class="c1">// 如果在 require.js 加载之前定义了 requirejs，require.js 会将其作为一个对象传入 requirejs.config</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">requirejs</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">onNodeCreated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">node</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;crossorigin&#39;</span><span class="p">,</span> <span class="s1">&#39;anonymous&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;//xxx.com/require.js&quot;</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 2.2.0 版本以上可用（很遗憾的是，目前的集成解决方案版本刚好低于这个版本）。</p>

<p>2.同时在 CDN 服务器增加响应头 <code>access-control-allow-orgin</code>，配置允许访问 CORS 的域，否则浏览器直接将禁止加载。</p>

<h3>try..catch</h3>

<p>这一点上面也有提到，算是一种比较通用，可定制强的方案。当然，在性能上也会有一些损耗。</p>

<p>综合考虑，try..catch 通用性更好，但由于其在性能方面的一些损耗，CORS 优于 try..catch</p>

<h2>一个监控小工具</h2>

<p>随后，介绍一个 JavaScript stack trace 的小工具：<a href="https://github.com/CurtisCBS/monitor">https://github.com/CurtisCBS/monitor</a> ，工具由 <a href="https://github.com/CurtisCBS">Curtis</a> 和 <a href="https://github.com/mirreal">mirreal</a> 共同完成。</p>

<p>主要是用于捕获页面 JavaScript 异常报错，捕获异常类型包含:</p>

<ul>
<li>JavaScript runtime 异常捕捉 √</li>
<li>静态资源 load faided 异常捕捉 √</li>
<li>console.error 的异常捕获 √</li>
<li>try..catch 错误捕获 √</li>
</ul>


<p>使用方式也很简单，但使用 script mode 引入文件后，调用 init 函数，进行初始化配置和监听</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;//unpkg.com/jstracker@latest/dist/jstracker.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script&gt;</span>
</span><span class='line'>  <span class="nx">jstracker</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">delay</span><span class="o">:</span> <span class="mi">1000</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">maxError</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">sampling</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">report</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">errorLogs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="nx">errorLogs</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果是使用 module mode，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// npm install jstracker --save</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">jstracker</span> <span class="nx">from</span> <span class="s1">&#39;jstracker&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">jstracker</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">concat</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">report</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">errorLogs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// console.log(&#39;send&#39;)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果要使用 try..catch 捕获，jstracker 暴露出一个 <code>tryJS</code> 对象，可以处理 try..catch 包装，就像这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="nx">jstracker</span> <span class="nx">from</span> <span class="s1">&#39;jstracker&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">this</span><span class="p">.</span><span class="nx">handleSelect</span> <span class="o">=</span> <span class="nx">jstracker</span><span class="p">.</span><span class="nx">tryJS</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handleSelect</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>所有错误信息统一由 report 函数处理，可以在此之上做数据处理：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// ubt.js</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">jstracker</span> <span class="nx">from</span> <span class="s1">&#39;jstracker&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">utility</span> <span class="nx">from</span> <span class="s1">&#39;utility&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">jstracker</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">concat</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">report</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">errorLogs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kr">const</span> <span class="nx">errorLog</span> <span class="o">=</span> <span class="nx">errorLogs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>        <span class="nx">errorLog</span><span class="p">.</span><span class="nx">ua</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">ubtTracker</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">errorLog</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">ubtTracker</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">key</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">UBT_JS_TRACKER</span><span class="o">:</span> <span class="s1">&#39;xxxx-xxxx-xxxx&#39;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span><span class="p">[</span><span class="s1">&#39;__bfi&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="nb">window</span><span class="p">[</span><span class="s1">&#39;__bfi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>
</span><span class='line'>        <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">deserializeUrl</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>        <span class="nb">window</span><span class="p">[</span><span class="s1">&#39;__bfi&#39;</span><span class="p">].</span><span class="nx">push</span><span class="p">([</span><span class="s1">&#39;_tracklog&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">UBT_JS_TRACKER</span><span class="p">,</span> <span class="nx">value</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">wrapContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">func</span> <span class="k">in</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">ctx</span><span class="p">[</span><span class="nx">func</span><span class="p">]</span> <span class="o">=</span> <span class="nx">jstracker</span><span class="p">.</span><span class="nx">tryJS</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">[</span><span class="nx">func</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">wrapContext</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">ubtTracker</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">jstracker</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>概述</h2>

<p>作为开发者以及项目维护者的身份，我们应当编写更安全健壮的代码。但由于环境的多样性，无论再完善的测试，code review 都难免都所疏漏，我们需要一套监控系统来完善整个前端体系。</p>

<p>在监控的时候，出于同源安全策略无法拿到准确的错误信息，在此，有两种解决方案：</p>

<ul>
<li>增加 CORS 支持</li>
<li>使用 try..catch 进行异常捕获</li>
</ul>


<p>最后，我们对整个监控工作封装了一个基础的核心，可以监控 JavaScript Runtime 异常，资源加载异常，以及 try..catch 捕获异常等，并给出一个实际工作中的示例。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[喜欢用 Git 做的一些小事]]></title>
    <link href="http://blog.mirreal.net/blog/2017/06/12/little-things-i-like-to-do-with-git/"/>
    <updated>2017-06-12T18:00:00+08:00</updated>
    <id>http://blog.mirreal.net/blog/2017/06/12/little-things-i-like-to-do-with-git</id>
    <content type="html"><![CDATA[<blockquote><p>作者：<a href="https://twitter.com/csswizardry">@csswizardry</a></p>

<p>原文：<a href="https://csswizardry.com/2017/05/little-things-i-like-to-do-with-git/">Little Things I Like to Do with Git</a></p>

<p>随便说点：这篇文章主要从管理者的角度谈论了使用 git 的心得，使用大量篇幅介绍 <code>git log</code> 的一些方法和技巧。</p>

<p>同样地，发现很多人其实并没有深入全面地去了解过 git 的用法，作为一名开发人员，大多数时候只要会使用 <code>git pull</code>，<code>git add</code>，<code>git commit</code>，<code>git push</code> 似乎就足够，还有很大一部分人只使用特定的图形化工具。但事实上真的是这样吗，可能在遇到某个稍微高级一点的问题或者需求就手足无措。对于某个特定个体而言，很多场景我们未必会遇到，即使碰到也可以现场寻求搜索工具的帮助，这也是一种学习方式，无意否定这种方式，但最大的问题就是只见一叶而难以窥见森林。在这里推荐一个小工具 <a href="https://github.com/Gazler/githug">githug</a>，通过一种比较轻松的游戏的方式来一探全貌。</p></blockquote>

<p>在跟我的朋友 Tim 聊天的时候，谈到我有多喜欢 Git。作为经常使用的一个工具，它强大而优雅。在这里，介绍一下我个人使用得最多，同时也是最有用的一些小技巧。</p>

<h2>管理者面板</h2>

<p>无论你认为在工作中的游戏化（gamification）和竞争是好是坏，对于这个话题在不同的时间可能是完全不同的结论。但如果你对团队成员在项目中的提交数量感兴趣，使用 <code>shortlog</code> 就可以找到答案：</p>

<p>（请忽略我）</p>

<p>（我只是占位的）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git shortlog -sn
</span><span class='line'>    <span class="m">80</span>  Harry Roberts
</span><span class='line'>    <span class="m">34</span>  Samantha Peters
</span><span class='line'>     <span class="m">3</span>  Tom Smith
</span></code></pre></td></tr></table></div></figure>


<p><code>shortlog</code> 可以视作对 <code>git log</code> 的概要。</p>

<ul>
<li><code>-s</code>选项将隐藏提交描述，仅提供提交计数摘要</li>
<li><code>-n</code> 选项将根据每个作者的提交数对输出进行排序，而不是默认的按作者字母顺序。</li>
</ul>


<p>上面显示的是项目生命周期的所有提交，但是如果想查看在特定时间内的情况，可以使用 <code>--since</code> 和 <code>--until</code> 选项：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git shortlog -sn --since<span class="o">=</span><span class="s1">&#39;10 weeks&#39;</span> --until<span class="o">=</span><span class="s1">&#39;2 weeks&#39;</span>
</span><span class='line'>    <span class="m">59</span>  Harry Roberts
</span><span class='line'>    <span class="m">24</span>  Samantha Peters
</span></code></pre></td></tr></table></div></figure>


<p>我为此配置了别名 <code>$ git stats</code></p>

<h2>责任人</h2>

<p>Git 有一个非常有用的 <code>blame</code> 功能，允许我们查看特定代码段的负责开发人员：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># See who last changed lines 5 through 10 of the buttons’ CSS:</span>
</span><span class='line'><span class="nv">$ </span>git blame -L5,10 _components.buttons.scss
</span></code></pre></td></tr></table></div></figure>


<p>这一条放在这里讲好像有点过头，像是我们在找开发人员哪些地方做错了。但也不完全是这样，另一方面，他们可能已经做了一些我们想要了解的特别厉害或是印象深刻的事情。我们原本会问，哇！我之前还没有看到这个功能，还想知道是谁做的。</p>

<p>由于是从 SVN 转到 Git，我使用 <code>praise</code> 作为 <code>blame</code> 的别名，这样二者都可以使用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git config --global alias.praise blame
</span></code></pre></td></tr></table></div></figure>


<p>即，我也可以这样做：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Find out who implemented Resource Hints and buy them a coffee:</span>
</span><span class='line'><span class="nv">$ </span>git praise -L18,23 _includes/head.html
</span></code></pre></td></tr></table></div></figure>


<p>只是一点小变化，但效果不错。</p>

<h2>隐藏空白提示</h2>

<p>当使用 <code>diff</code> 或 <code>show</code> 查看具有大量空白变化的版本对比时，会有很多视觉噪音干扰我们，使得很难看到更重要的变化内容。</p>

<p>幸运的是，去除这种空白提示非常容易，在 <code>git diff</code> 和 <code>git show</code> 使用 <code>-w</code> 选项就可以轻松搞定。比如，之前：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'> a <span class="o">{</span>
</span><span class='line'>   color: <span class="nv">$color</span>-links<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>-<span class="p">&amp;</span>:hover <span class="o">{</span>
</span><span class='line'>-  color: <span class="nv">$color</span>-links-hover<span class="p">;</span>
</span><span class='line'>-<span class="o">}</span>
</span><span class='line'>+  <span class="p">&amp;</span>:hover <span class="o">{</span>
</span><span class='line'>+    color: <span class="nv">$color</span>-links-hover<span class="p">;</span>
</span><span class='line'>+    text-decoration: underline<span class="p">;</span>
</span><span class='line'>+  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用 <code>-w</code> 之后：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'> a <span class="o">{</span>
</span><span class='line'>   color: <span class="nv">$color</span>-links<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="p">&amp;</span>:hover <span class="o">{</span>
</span><span class='line'>     color: <span class="nv">$color</span>-links-hover<span class="p">;</span>
</span><span class='line'>+    text-decoration: underline<span class="p">;</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在可以很容易看出，唯一有意义的变化是增加了 <code>text-decoration: underline;</code>，而其余​​的 <code>diff</code> 是有点误导性的。</p>

<h2>仅显示单词的变化而不是整行</h2>

<p>写代码跟写文章不同，查看变化的单词而不是整行通常会更有用; 这在编辑 markdown 文档时尤其有用，就像现在。</p>

<p>幸运的是，我们只要使用 <code>--word-diff</code> 选项就能显示单词的变化：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git diff --word-diff
</span></code></pre></td></tr></table></div></figure>


<p>跟不使用 <code>--word-diff</code> 选项的区别还是很大的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>-My friend Tom recently gave an excellent talk
</span><span class='line'>+My good friend Tom gave an excellent talk
</span></code></pre></td></tr></table></div></figure>


<p>如果启用 <code>--word-diff</code>，我们能得到更便于理解和更有用的概览：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>My <span class="o">{</span>+good+<span class="o">}</span> friend Tom <span class="o">[</span>-recently-<span class="o">]</span> gave an excellent talk
</span></code></pre></td></tr></table></div></figure>


<p>注意只有变化的文本被突出显示（通过 <code>{+ +}</code> 和 <code>[- -]</code>)</p>

<h2>查看最近工作的分支</h2>

<p>在任何给定的项目，在许多不同的分支之间切换是很常见的，并且跟踪它们可能相当棘手。我们可以让 Git 帮助我们解决这个问题：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git <span class="k">for</span>-each-ref --count<span class="o">=</span><span class="m">10</span> --sort<span class="o">=</span>-committerdate refs/heads/ --format<span class="o">=</span><span class="s2">&quot;%(refname:short)&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过这个命令可以知道最近在工作的 10（&ndash;count=10）个分支，按照上次工作的时间排序。只显示本地分支（<code>refs/heads/</code>），并通过 <code>--format</code> 选项获得更友好的呈现方式。</p>

<p>这是一个有点冗长的命令，所以我为此配置别名 <code>$ git recent</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git config --global alias.recent <span class="s2">&quot;for-each-ref --count=10 --sort=-committerdate refs/heads/ --format=\&quot;%(refname:short)\&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>看到每个人都在做什么</h2>

<p>有时候，特别是对于团队领导，了解团队成员在所有分支的行为概览是很有用的。再一次地，Git 可以让这一切变得很容易：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git log --all --oneline --no-merges
</span></code></pre></td></tr></table></div></figure>


<p>这可以得到一份关于所有人的日志报告简化版（带有 <code>--no-merges</code> 选项）</p>

<p>我们也可以通过 <code>--since</code> 选项来限制返回的提交数量：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git log --all --since<span class="o">=</span><span class="s1">&#39;2 weeks&#39;</span> --oneline --no-merges
</span></code></pre></td></tr></table></div></figure>


<p>这样我们可以看到，在过去的两个星期里，每个人都在做什么。</p>

<p>可以配置一个别名 <code>$ git overview</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git config --global alias.overview <span class="s2">&quot;log --all --since=&#39;2 weeks&#39; --oneline --no-merges&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>提醒你自己已经做了什么</h2>

<p>当你回到一个比较旧的项目，或是在长时间休息之后回到办公室，可能不知道你最后在做什么工作，这种情况时常发生。我们可以通过 Git 轻松获得我们在项目中的工作情况：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git log --all --oneline --no-merges --author<span class="o">=</span>&lt;your email address&gt;
</span></code></pre></td></tr></table></div></figure>


<p>和上一条很类似，只是我们将日志限制于我们自己的提交，也可以增加 <code>--since</code> 限制。</p>

<p>这也有一个别名 <code>$ git recap</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git config --global alias.recap <span class="s2">&quot;log --all --oneline --no-merges --author=name@mail.com&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>今天的工作</h2>

<p>同样地，不在这里讨论如何衡量开发人员的生产力，但我觉得让客户知道我在任何一天的工作情况是很有用的。不是要你保留完成任务的详细列表，我们可以使用 Git 获取所有这些信息：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git log --since<span class="o">=</span>00:00:00 --all --no-merges --oneline --author<span class="o">=</span>&lt;your email address&gt;
</span></code></pre></td></tr></table></div></figure>


<p>这将记录（<code>log</code>） 你工作的所有（<code>--all</code>）分支，谁（<code>--author</code>）从（<code>--since</code>）午夜开始都做了什么，（不包括合并提交 <code>--no-merges</code>），并提供一个简单的一行 （<code>--oneline</code>） 概述。</p>

<p>我有这个别名 <code>$ git today</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git config --global alias.today <span class="s2">&quot;log --since=00:00:00 --all --no-merges --oneline --author=name@mail.com&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>生成更改日志</h2>

<p>维护一份 CHANGELOG 可能有点乏味，我们必须查看自上次发布以来所做的所有工作，然后提取其中有用的部分。幸运的是，我们可以使用 Git 来给我们一个好的开头：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git log --oneline --no-merges &lt;last tag&gt;..HEAD
</span></code></pre></td></tr></table></div></figure>


<p>注意：<code>HEAD</code> 是可选的，如果你省略（即&hellip; &ndash;no-merges <last tag>..），<code>HEAD</code> 会是隐含的，当然这样可以节省几次敲击键盘的时间。</p>

<p>这将创建一个简化的日志，显示最后一个发布版本和 <code>HEAD</code> 之间的所有提交（不包括合并提交）。</p>

<p>例如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git log --oneline --no-merges 1.0.0..
</span><span class='line'>1257b95 <span class="o">[</span>refs <span class="c">#00019] Bump version</span>
</span><span class='line'>2b9b28e <span class="o">[</span>refs <span class="c">#00019] Add auto width class</span>
</span><span class='line'>17b8eb1 <span class="o">[</span>refs <span class="c">#00015] Tidy up README.md</span>
</span><span class='line'>bbe7d05 <span class="o">[</span>refs <span class="c">#00012] Rename Supercell main mixin</span>
</span></code></pre></td></tr></table></div></figure>


<p>这告诉我，自从上次发布（1.0.0）到当前项目状态（<code>HEAD</code>），已经完成哪些工作。这对于 CHANGELOG 来说是一个很好的参考。</p>

<p>注意：不仅仅适用于 tag，还可以使用提交哈希。</p>

<h2>检查需要拉取哪些变化</h2>

<p>如果你在一段时间内不在项目，可能需要先检查上游的变更，然后再将这些更新下载到本地分支。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git log --oneline --no-merges HEAD..&lt;remote&gt;/&lt;branch&gt;
</span></code></pre></td></tr></table></div></figure>


<p>注意：同样地，<code>HEAD</code> 在这里是可选的，省略将使其隐含。</p>

<p>例如，让我们来看看你在度假时在特性分支做了什么：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git checkout feature/fonts
</span><span class='line'><span class="nv">$ </span>git fetch
</span><span class='line'><span class="nv">$ </span>git log --oneline --no-merges ..origin/feature/fonts
</span></code></pre></td></tr></table></div></figure>


<p>我使用这个别名 <code>$ git upstream</code>。</p>

<h2>检查即将上传的内容</h2>

<p>最好的情况是可以经常提交和上传，但如果某种原因导致有大量的本地提交尚未上传，可以快速回顾一下都是什么。</p>

<p>为了做到这一点，我们反转之前的命令就能轻松实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git log --oneline --no-merges &lt;remote&gt;/&lt;branch&gt;..HEAD
</span></code></pre></td></tr></table></div></figure>


<p>例如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git fetch
</span><span class='line'><span class="nv">$ </span>git log --oneline --no-merges origin/feature/fonts..HEAD
</span></code></pre></td></tr></table></div></figure>


<p>注意：同样地，<code>HEAD</code> 在这里是可选的，省略将使其隐含。</p>

<p>这将记录 <code>HEAD</code> 需要上传到 <code>&lt;remote&gt;/&lt;branch&gt;</code> 的提交。</p>

<p>我使用这个别名 <code>$ git local</code>。</p>

<h2>查看复杂日志</h2>

<p>上面的每一个例子都使用简化的日志，因为只想快速了解发生了什么。对于更多细节，我使用带有 <code>--graph</code> 选项的日志和一些额外的选项：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git log --graph --all --decorate --stat --date<span class="o">=</span>iso
</span></code></pre></td></tr></table></div></figure>


<p>这将给出所有（<code>--all</code>）分支基于 <code>--graph</code> 的提交记录 <code>--stat</code>（添加，删除）日志。<code>--decorate</code> 选项会告诉我们提交信息适用于那些分支，还包含一个更加严格的日期格式。</p>

<p>我使用这个别名 <code>$ git graph</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git config --global alias.graph <span class="s2">&quot;log --graph --all --decorate --stat --date=iso&quot;</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[移除在 ESM 模式生成的严格模式]]></title>
    <link href="http://blog.mirreal.net/blog/2017/06/05/remove-strict-node/"/>
    <updated>2017-06-05T18:00:00+08:00</updated>
    <id>http://blog.mirreal.net/blog/2017/06/05/remove-strict-node</id>
    <content type="html"><![CDATA[<h2>起源</h2>

<p>项目升级构建方式，以前的代码采用 AMD 风格组织代码，并使用 <code>r.js</code> 完成打包优化工作。后续成员选择采用 ES6 的风格编写代码，然后 webpack + babel 完成打包构建。迁移工作并不如想象中那么容易，终于完成各种配置，测试时候发现问题：抛出一个语法错误。错误很快被定位，属于历史代码的不规范写法，之所以现在暴露出来是因为新的构建方式会加入 <code>"use strict"</code>。</p>

<h2>严格模式</h2>

<p>在编写代码的过程中，我们使用 <code>strict mode</code> 是一种很好的方式，严格模式会将 JavaScript 陷阱直接变成明显的错误，比如未声明导致的全局变量，可以让我们开发过程中就发现错误。</p>

<p>众所周知，JavaScript 这门语言之前存在大量不好的设计，使用严格模式意味着在采用一种限制性更高的方式编写代码，同时更 “安全”。但这里所谓的安全在生产环境又可能是另外一回事，尤其是对于那些上了年纪的历史代码，我们更倾向于在生产环境去除严格模式。</p>

<h2>ES2015+</h2>

<p>现在大部分人已经在使用更强大，更具有表现力的 <code>ES2015+</code> 编写代码。可能还会使用到 babel 来转化成用于生产环境运行的代码，在使用 <code>preset es2015</code> 时，会自动加入 <code>“use strict”</code>。</p>

<p>babel 的处理方式是将 ES2015 模块转换成 <code>CommonJS</code> 格式的，然后再统一处理，即 <code>transform-es2015-modules-commonjs</code>，这个插件位于 <code>preset es2015</code> 中，并且依赖于 <code>transform-strict-mode</code></p>

<h2>也许你会想去掉严格模式</h2>

<p>也许你会想去掉严格模式，毕竟对于一些历史代码，很难预测加入严格模式会导致什么异常。</p>

<!-- 可以从两个方面来考虑： -->


<ul>
<li>第一，在处理过程中去掉 <code>"use strict"</code>，这里不用我们自己去写了，借助这个插件 <code>transform-remove-strict-mode</code></li>
<li>第二，不用 <code>transform-es2015-modules-commonjs</code>，可以使用 <code>webpack 2</code> 直接处理 ES6 模块</li>
</ul>


<h3>方案一</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>npm install babel-plugin-transform-remove-strict-mode --save-dev
</span></code></pre></td></tr></table></div></figure>


<p>修改 <code>.babelrc</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;presets&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">[</span><span class="s2">&quot;es2015&quot;</span><span class="p">],</span>
</span><span class='line'>        <span class="s2">&quot;stage-0&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;react&quot;</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;plugins&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;transform-remove-strict-mode&quot;</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>方案二</h3>

<blockquote><p><a href="https://babeljs.io/docs/plugins/preset-es2015/#optionsmodules">modules</a></p>

<p><code>"amd" | "umd" | "systemjs" | "commonjs" | false</code>, defaults to <code>"commonjs"</code>.</p>

<p>Enable transformation of ES6 module syntax to another module type.</p>

<p>Setting this to <code>false</code> will not transform modules.</p></blockquote>

<p>我们去掉 <code>preset es2015</code> 的模块处理，改由 <code>webpack</code> 来处理：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;presets&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">[</span><span class="s2">&quot;es2015&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nt">&quot;modules&quot;</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}],</span>
</span><span class='line'>        <span class="s2">&quot;stage-0&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;react&quot;</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这种方案也能解决之前问题，因为之前存在问题的模块使用 ES5 编写的，使用 AMD 风格。</p>

<p>但是，参考 <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-strict-mode-code">http://www.ecma-international.org/ecma-262/6.0/#sec-strict-mode-code</a> ，在 ES6 语法下，模块系统以及 class 等仍然都是工作在 <code>strict mode</code> 下的，而 webpack2 的也确实是这样处理的。</p>

<p>实现对语言本身是没问题的，使用新语法意味着我们要抛弃掉以前一些设计不好的地方，编写高质量的代码。</p>

<h3>对比</h3>

<p>相比而言，方案二更合适，因为方案一处理的过程实际是删除所有<code>"use strict"</code>，有时候未必符合你本来的意愿。</p>

<p>采用方案二还有一些好处，比如可以使用 <code>webpack2</code> 已经支持的 <code>tree shaking</code> 优化技术，因为这项技术基于 <code>ES6 Modules</code>，得让 <code>webpack</code> 直接处理才能使用。</p>

<h2>后续</h2>

<p>这种属于历史遗留问题，比如不小心引入的全局变量，类似的代码质量问题还不少。</p>

<p>所以，我们使用 lint 工具来帮助我们避免这种问题，对于代码质量的要求必须苛刻。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[编写现代 JavaScript 代码]]></title>
    <link href="http://blog.mirreal.net/blog/2017/06/02/writing-modern-javascript-code/"/>
    <updated>2017-06-02T18:00:00+08:00</updated>
    <id>http://blog.mirreal.net/blog/2017/06/02/writing-modern-javascript-code</id>
    <content type="html"><![CDATA[<blockquote><p>原文作者：<a href="https://twitter.com/scastiel">Sébastien Castiel</a></p>

<p>原文链接：<a href="https://dev.to/scastiel/writing-modern-javascript-code">Writing modern JavaScript code</a></p>

<p>说点什么：这是一篇很朴素的文章，讲的道理都懂，但实际上，在工作中遇到类似的情形却未必如此，编写可维护，可阅读，更安全的代码是我们应有的责任。</p></blockquote>

<p>是不是还认为 JavaScript 是一门用于在光标悬浮时改变页面元素的语言？这些日子已经不复存在，每一种语言都在随着时间推移而发展，我们使用语言的方式同样也在发展。看一下你一两年前写的代码：会感到羞愧吗？如果是的话，这篇文章应该很适合你。</p>

<p>这里会列出一些所谓的最佳实践，目的是让你的 JavaScript 代码更容易编写，阅读和维护。</p>

<h2>使用可格式化代码的 linter</h2>

<p>第一个建议是使用 linter 工具，可以帮助你检查在不同文件是否遵守一致的规则，尤其是当不同开发人员在同一个项目上工作：缩进，括号中的空格，替换 <code>==</code> 为 <code>===</code> &hellip;</p>

<p>但更重要的是，尽可能使用 linter 工具自动修复代码。<a href="http://eslint.org/">ESLint</a> 就做得很好（带有 <code>--fix</code> 选项），而且与所有主流 IDE 完美集成，可以在保存时自动修复文件。</p>

<p>还可以使用 <a href="https://github.com/prettier/prettier">Prettier</a>，不过这款工具更注重格式化而不是静态检查，但处理后的结果基本相同。</p>

<p>下一步将介绍与 linter 工具一起使用的规则：</p>

<h2>为你的 linter 定制现代化的规则</h2>

<p>如果不知道你的代码需要什么样的规则，可以参考：<a href="https://standardjs.com/">StandardJS</a>。这是一个<strong>非常</strong>严格的 linter，无法修改配置，但里面的每一条规则已经越来越多地被社区接纳。比如：</p>

<ul>
<li>使用 2 个空格缩进（我曾经使用 4 个空格，但实际使用起来 2 个空格很不错）</li>
<li>不使用分号（一开始可能会觉得奇怪，但几天后就再也回不去了）</li>
<li>在关键字（如 if）和花括号使用空格，在括号不使用空格</li>
<li><a href="https://standardjs.com/rules.html">等等</a>。</li>
</ul>


<p>StandardJS 是一个独立的 Node 模块，可以进行 lint 和修复代码，但如果要在现有的大型项目中使用，并且想要停用一些规则（因为有些地方可能需要作大量修改），还可以使用 <a href="https://github.com/feross/eslint-config-standard">ESLint 预定配置</a>。比如，我就停用了规则 <a href="http://eslint.org/docs/rules/no-mixed-operators">no-mixed-operators</a> 和 <a href="https://github.com/benmosher/eslint-plugin-import/blob/master/docs/rules/no-webpack-loader-syntax.md">import / no-webpack-loader-syntax</a>。</p>

<h2>使用 ES2015+ 的新特性</h2>

<p>如果你在使用 JavaScript 开发，根本没办法不听说 ES2015 +（或 ES6，ES7 &hellip;）的特性。有的已经是我离不开的：</p>

<ul>
<li>箭头函数：对于函数式编程，比如写 <code>x =&gt; x * 2</code> 这样的函数非常有用（见下一点）</li>
<li>类：停止使用原型函数，使用类更酷炫（但不要滥用，JavaScript 比任何面向对象的语言好多了）</li>
<li>对数组和对象的操作：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">doSomething</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">doSomethingElse</span><span class="p">()</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">doSomethingWithA</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">otherResults</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">c</span><span class="o">:</span> <span class="s1">&#39;😺&#39;</span><span class="p">,</span> <span class="nx">d</span><span class="o">:</span> <span class="s1">&#39;🐶&#39;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="p">...</span><span class="nx">otherResults</span> <span class="p">}</span> <span class="c1">// equivalent to { a: a, b: b }</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kr">const</span> <span class="p">{</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="p">...</span><span class="nx">rest</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">doSomething</span><span class="p">()</span> <span class="c1">// Also works with arrays!</span>
</span><span class='line'><span class="c1">// `rest` looks like { b: ..., d: &#39;🐶&#39; }</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>使用 <code>async/await</code> 编写更简单的异步处理：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Please try to write the same code with classic promises ;)</span>
</span><span class='line'><span class="nx">async</span> <span class="kd">function</span> <span class="nx">doSomething</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">getValueForA</span><span class="p">()</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">getValueForBFromA</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
</span><span class='line'>  <span class="kr">const</span> <span class="p">[</span><span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">]</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
</span><span class='line'>    <span class="c1">// parallel execution</span>
</span><span class='line'>    <span class="nx">getValueForC</span><span class="p">(),</span> <span class="nx">getValueForDFromB</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
</span><span class='line'>  <span class="p">])</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">total</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">calculateTotal</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">total</span> <span class="o">/</span> <span class="mi">1000</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>想知道如何使用这些特性呢？<a href="https://blog.castiel.me/posts/002-use-the-coolest-es6-features-everywhere.html">我的另一篇文章能给一些建议</a>。（顺便说一下，使用最新版本的 Node.js，可能不再需要 Babel 就能使用这些新特性）</p>

<h2>使用函数式编程</h2>

<p>函数式编程最近很热门，取得不少成就，而且不仅仅是在 JavaScript 中。为什么呢？函数式编程能使代码更具可预测性，确定性，更安全，一旦习惯这种方式，代码会更容易维护。这里有一些简单的建议：</p>

<p>首先，停止使用 for 循环，在大多数（可能是所有？）情况下根本不需要。例如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="mi">13</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="mi">7</span> <span class="p">}]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Instead of:</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">calculatedValue</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span> <span class="o">*</span> <span class="mi">10</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">calculatedValue</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">[</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">calculatedValue</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Prefer:</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">arr</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">elem</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">calculatedValue</span><span class="o">:</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">value</span> <span class="o">*</span> <span class="mi">10</span> <span class="p">}))</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">elem</span> <span class="o">=&gt;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">calculatedValue</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">elem</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span><span class='line'>    <span class="p">[</span><span class="nx">elem</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span><span class="o">:</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">calculatedValue</span><span class="p">,</span>
</span><span class='line'>    <span class="p">...</span><span class="nx">acc</span>
</span><span class='line'>  <span class="p">}),</span> <span class="p">{})</span>
</span></code></pre></td></tr></table></div></figure>


<p>好吧，这实际上是一个非常极端的例子，对于不习惯函数式编程的人而言，可能看起来更加复杂。但我们可以稍微简化一下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">enrichElementWithCalculatedValue</span> <span class="o">=</span>
</span><span class='line'>  <span class="nx">elem</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">calculatedValue</span><span class="o">:</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">value</span> <span class="o">*</span> <span class="mi">10</span> <span class="p">})</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">filterElementsByValue</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">=&gt;</span>
</span><span class='line'>  <span class="nx">elem</span> <span class="o">=&gt;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">calculatedValue</span> <span class="o">&gt;</span> <span class="nx">value</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">aggregateElementInObject</span> <span class="o">=</span> <span class="p">(</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">elem</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span><span class='line'>  <span class="p">[</span><span class="nx">elem</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span><span class="o">:</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">calculatedValue</span><span class="p">,</span>
</span><span class='line'>  <span class="p">...</span><span class="nx">acc</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">arr</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">enrichElementWithCalculatedValue</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">filterElementsByValue</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">aggregateElementInObject</span><span class="p">,</span> <span class="p">{})</span>
</span></code></pre></td></tr></table></div></figure>


<p>在这里，我们定义了三个函数，其功能基本上与其名字一致。第二个建议：创建局部函数（即使是在已经存在的函数中）来说明代码的功能，不需要使用注释。</p>

<p>注意，三个局部函数不修改它们的执行上下文。没有外部变量被修改，没有其他服务被调用&hellip;在函数式编程中，它们被称为<em>纯函数</em>。纯函数具有很大的优势：</p>

<ul>
<li>很容易测试，因为从给定参数只有一个可能的结果，不管被调用了多少次;</li>
<li>无论应用状态如何，都能保证相同的结果;</li>
<li>应用状态在函数调用之前和之后保持不变。</li>
</ul>


<p>所以我的第三个建议是：尽可能地使用纯函数。</p>

<h2>其他的一些建议</h2>

<ul>
<li>习惯于使用异步代码，并多使用 promise，看看 <a href="http://reactivex.io/rxjs/">RxJS</a> 的 observales（有<a href="http://reactivex.io/learnrx/">一个很棒的教程关于从函数式编程到响应式编程</a>）</li>
<li>写测试！这应该是很明显的，但是据我所知很多项目都有未经测试的代码，尽管测试 JavaScript（前端或后端）并不困难。</li>
<li>使用最新的语言特性：比如不要再写 <code>arr.indexOf(elem) !== -1</code>，而应该写成 <code>arr.includes(elem)</code>。</li>
<li>大量阅读技术文章：<a href="https://www.reddit.com/r/javascript/">JavaScript subreddit</a> 是了解目前社区最酷做法的一个很好的来源。</li>
</ul>


<p>总而言之，最好的建议就是：<strong>总是重构你的代码</strong>。比如改进你一年前写过的模块？借此机会，用 <code>const</code> 取代 <code>var</code>，使用箭头函数或 <code>async/await</code> 简化代码&hellip;&hellip;和你喜欢的代码工作一件很愉悦的事。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JavaScript 模块化现状]]></title>
    <link href="http://blog.mirreal.net/blog/2017/05/29/the-state-of-javascript/"/>
    <updated>2017-05-29T18:00:00+08:00</updated>
    <id>http://blog.mirreal.net/blog/2017/05/29/the-state-of-javascript</id>
    <content type="html"><![CDATA[<blockquote><p>原文作者：Johannes Ewald <a href="https://twitter.com/Jhnnns">@Jhnnns</a></p>

<p>原文链接：<a href="https://medium.com/webpack/the-state-of-javascript-modules-4636d1774358">The state of JavaScript modules</a></p>

<p>已获原作者授权翻译及发布</p></blockquote>

<p>ESM, CJS, UMD, AMD — 到底应该选择哪一个？</p>

<p>最近 <a href="https://twitter.com/addyosmani/status/859296190323597313">在 twitter</a> 上有很多关于 <a href="http://2ality.com/2014/09/es6-modules-final.html">ES Module</a> 现状的讨论，<a href="https://twitter.com/bradleymeck/status/863061949021650944">尤其是在 Node.js 上</a>，他们计划引入新的文件扩展名 <code>*.mjs</code>。人们有足够理由对此感到 <a href="https://twitter.com/tankredhase/status/861864123922907136">担忧和不确定</a>，因为这个话题异常复杂，接下来会尽力阐述清楚问题。</p>

<h2>来自远古的恐惧</h2>

<p>大多数前端开发者应该还记得 <a href="https://medium.com/@trek/last-week-i-had-a-small-meltdown-on-twitter-about-npms-future-plans-around-front-end-packaging-b424dd8d367a">Javascript 依赖管理的黑暗时期</a>。那个时候，你需要把一个库复制粘贴到 vendor 文件夹，然后作为一个全局变量引入，要自己去按次序组合所有东西，可能还要管理命名空间。</p>

<p>在过去的那些年，我们能深刻体会到公共模块格式化和中央模块管理的价值。</p>

<p>在今天，不管是发布还是使用一个库都要容易得多，只需要使用 <code>npm publish</code> 和 <code>npm install</code> 命令就行。这就是人们会那么紧张两种模块系统兼容性问题的原因：他们不想失去已有的舒适区。</p>

<p>接下来我会解释和总结现有实现的情况，以及为什么 Node 生态迁移到 ES Module（ESM）会那么难。在最后，总结这些变化对 webpack 使用者和模块作者有什么影响。</p>

<h2>现有实现</h2>

<p>目前，ESM 有三种方式的实现：</p>

<ul>
<li>浏览器</li>
<li>webpack 以及类似的构建工具</li>
<li>Node（未完成，<a href="https://twitter.com/rauschma/status/866334160218095617">但可能在年底作为一个实验功能</a>）</li>
</ul>


<p>为了更好地理解现在的讨论，首先要知道 ES2015 包含两种模式：</p>

<ul>
<li><code>script</code> 用于具有全局命名空间的常规脚本</li>
<li><code>module</code> 用于具有明确导入和导出的模块化代码</li>
</ul>


<p>如果你试图在 <code>script</code> 标签使用 <code>import</code> 或者 <code>export</code> 语句，会抛出一个 SyntaxError。这种语句在全局环境下没有任何意义。另一方面，<code>module</code> 模式即意味着<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Strict_mode">严格模式</a>，禁止使用某些语言特性，比如 <code>with</code> 语句。因此，需要在脚本被解析和执行之前定义模式。</p>

<h2>浏览器中的 ESM</h2>

<p>截至到 2017 年 5 月，所有主流浏览器都开始做了 ESM 的实现工作。不过，大部分仍处于在实验性质。这里不会做详细介绍，因为 <a href="https://jakearchibald.com/2017/es-modules-in-browsers/">Jake Archibald 已经写了一篇很厉害的文章</a>。</p>

<p>除了一些小的困难，在浏览器中实现起来非常容易，因为以前并没有模块系统。想要指定 <code>module</code> 模式，需要在 <code>script</code> 标签添加 <code>type="module"</code> 属性，如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;module&quot;</span> <span class="na">src=</span><span class="s">&quot;main.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>在一个模块中，现在只能使用有效的 <code>URL</code> 作为模块标识符。模块标识符是用于 require 或 import 其他模块的字符串。为了确保未来兼容 CJS 模块标识符，“纯” 导入标识符（如 <code>import "lodash"</code>）现在还不支持。模块标识符必须是绝对 <code>URL</code> 或者是以 <code>/</code>，  <code>./</code>,  <code>../</code> 开头：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Supported:</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">foo</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;https://jakearchibald.com/utils/bar.js&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">foo</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;/utils/bar.js&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">foo</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;./bar.js&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">foo</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../bar.js&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Not supported:</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">foo</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;bar.js&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">foo</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;utils/bar.js&#39;</span><span class="p">;</span>
</span><span class='line'><span class="c1">// Example from https://jakearchibald.com/2017/es-modules-in-browsers/</span>
</span></code></pre></td></tr></table></div></figure>


<p>同样需要注意的是，一旦处在一个模块中，每个导入也将被解析为 <code>module</code>，而且没有办法 <code>import</code> 一个 <code>script</code>。</p>

<h2>ESM 与 webpack</h2>

<p>类似 webpack 这样的构建工具通常会尝试用 <code>module</code> 模式解析代码，有问题再切回到 <code>script</code> 模式。这些工具最终会生成一段 <code>script</code>，通常是在一定程度上模拟 CJS 和 ESM 行为的模块运行时。</p>

<p>我们以这两个简单的 ESM 为例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// a.js</span>
</span><span class='line'><span class="kr">export</span> <span class="kd">let</span> <span class="nx">number</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span><span class='line'><span class="kr">export</span> <span class="kd">function</span> <span class="nx">incr</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">number</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// test.js</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span> <span class="nx">number</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;./a&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">number</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>webpack 使用函数包装器封装模块范围和对象引用来模拟 <a href="http://2ality.com/2015/07/es6-module-exports.html">ESM 实时绑定</a>。每次编译，还包括一个模块运行时，负责引导和缓存模块。此外，将模块标识转换为数字模块 ID。这样可以减少打包的大小和引导时间。</p>

<p>这是什么意思呢？我们来看看编译输出：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">modules</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// This is the module runtime.</span>
</span><span class='line'>    <span class="c1">// It&#39;s only included once per compilation.</span>
</span><span class='line'>    <span class="c1">// Other chunks share the same runtime.</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">installedModules</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>    <span class="c1">// The require function</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">__webpack_require__</span><span class="p">(</span><span class="nx">moduleId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="c1">// Load entry module and return exports</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">__webpack_require__</span><span class="p">(</span><span class="nx">__webpack_require__</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">([</span> <span class="c1">// An array that maps module ids to functions</span>
</span><span class='line'>    <span class="c1">// a.js as module id 0</span>
</span><span class='line'>    <span class="kd">function</span> <span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">__webpack_exports__</span><span class="p">,</span> <span class="nx">__webpack_require__</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">__webpack_exports__</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">configurable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">get</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">number</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="nx">number</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">function</span> <span class="nx">incr</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">number</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="c1">// test.js as module id 1</span>
</span><span class='line'>    <span class="kd">function</span> <span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">__webpack_exports__</span><span class="p">,</span> <span class="nx">__webpack_require__</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">__WEBPACK_IMPORTED_MODULE_0__a__</span> <span class="o">=</span> <span class="nx">__webpack_require__</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Object reference as &quot;live binding&quot;</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">__WEBPACK_IMPORTED_MODULE_0__a__</span><span class="p">[</span><span class="s2">&quot;a&quot;</span> <span class="cm">/* number */</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">]);</span>
</span></code></pre></td></tr></table></div></figure>


<p>简化的 webpack 输出，模拟 ES Modules 行为</p>

<p>结果已经简化并删除了一些与此示例无关的代码。你会发现，webpack 在 <code>exports</code> 对象上将所有 <code>export</code> 语句替换成 <code>Object.defineProperty</code>，并使用属性访问器替换对引入值的所有引用。还要注意每个 ESM 开始时的 <code>"use strict"</code> 指令，这是由 webpack 自动添加，在 ESM 中必须是严格模式。</p>

<p>这种实现只是模拟，因为它试图模仿 ESM 和 CJS 的行为 &ndash; 但不是与其完全保持一致。比如，这种模拟并不符合某些边缘情况。看下面这个模块：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果你通过加上 <code>babel-preset-es2015</code> 的 Babel 来运行，结果是：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kc">undefined</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>从输出结果可以看出，Babel 假设默认是 ESM，因为 <code>module</code> 模式即代表严格模式，在严格模式下会将 <code>this</code> 初始化为 <code>undefined</code>。</p>

<p>然而，使用 webpack，结果是：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>在引导模块时，<code>this</code> 将指向 <code>exports</code> ，与 Node.js 使用的 CJS 行为一致。这是因为语法上不确定是 <code>script</code> 还是 <code>module</code>，解析器无法判断该模块是 ESM 还是 CJS。在不明确的时候，webpack 会模拟 CJS，因为它仍然是最受欢迎的模块风格。</p>

<p>这种模拟其实已经包含了很多情况，因为模块作者通常会避免这种代码。然而，“很多情况”对于像 Node.js 这样的平台是不够的，因为它需要保证所有有效的 JavaScript 代码都能正常运行。</p>

<h2>Node.js 中的 ESM</h2>

<p>Node.js 在执行 ESM 时遇到了麻烦，因为仍然需要支持 CJS，语法看起来相似，但运行时行为完全不同。<a href="https://github.com/nodejs/CTC">Node.js 核心技术委员会</a>（CTC）成员 James M Snell 撰写了<a href="https://hackernoon.com/node-js-tc-39-and-modules-a1118aecf95e">一篇很好的文章来解释 CJS 与 ESM 之间的差异</a>。</p>

<p>归结起来，CJS 是一个动态模块系统，ESM 是静态模块系统。</p>

<h3>CJS</h3>

<ul>
<li>允许动态同步 <code>require()</code></li>
<li>导出仅在模块执行后才知道</li>
<li>导出可以在模块初始化后添加，替换和删除</li>
</ul>


<h3>ESM</h3>

<ul>
<li>只允许静态同步 <code>import</code></li>
<li>在模块执行之前，导入和导出已经关联</li>
<li>导入和导出是不可变的</li>
</ul>


<p>由于  CJS 早于 ES2015，所以一直在 <code>script</code> 模式下解析，封装通过使用函数包装器实现。在 Node.js 中加载 CJS，实际上会执行与此类似的代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">module</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">exports</span><span class="o">:</span> <span class="p">{}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">require</span> <span class="o">=</span> <span class="nx">makeRequireFunction</span><span class="p">();</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">filename</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">dirname</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="cm">/* YOUR CODE */</span>
</span><span class='line'><span class="p">})(</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">dirname</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>对 Node.js 的 CommonJS 模块的简单函数包装</p>

<p>问题出现了，将两个模块系统集成到同一个运行时时，ESM 和 CJS 之间的循环依赖可能会迅速导致类似死锁的情况。</p>

<p>而且，由于现有 CJS 模块数量庞大，也不能直接放弃对 CJS 的支持。为了避免 Node.js 生态的中断，有两点已经很明显：</p>

<ul>
<li>现有的 CJS 代码必须以相同的方式继续工作</li>
<li>两个模块系统都必须同时且尽可能无缝地工作</li>
</ul>


<h3>目前的权衡</h3>

<p>2017 年 3 月，经过几个月的讨论，CTC 终于找到了一种解决问题的办法。由于在 ES 规范和引擎不改变的情况下无法进行无缝集成，<a href="https://github.com/bmeck/node-eps/blob/a1eab9bf023bbe13a79ddb18f0622a5d57215f9b/002-es-modules.md">CTC 决定开始一些权衡之后的实现工作</a>：</p>

<h4>1.ESM 必须是 <code>*.mjs</code> 文件扩展名</h4>

<p>这是由于上面提及的模糊语法问题，无法通过解析来确切知晓 JavaScript 代码是什么类型。为了 Node.js 向后兼容的目标，作者需要加入一种新模式。<a href="https://github.com/nodejs/node/wiki/ES6-Module-Detection-in-Node#detection-problem">已经有关于各种替代品的讨论</a>，但使用不同文件扩展名是解决目前问题的最佳权衡。</p>

<h4>2.CJS 只能异步导入 ESM import()</h4>

<p>Node.js 将异步加载 ESM，以便尽可能接近浏览器的行为。因此，同步的 <code>require()</code> 在 ESM 是不可能的，并且依赖于 ESM 的每个功能都需要异步：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">driverPromise</span> <span class="o">=</span> <span class="kr">import</span><span class="p">(</span><span class="s2">&quot;dbdriver&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">readFromDb</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">query</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="p">(</span><span class="nx">await</span> <span class="nx">driverPromise</span><span class="p">).</span><span class="nx">read</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h4>3. CJS 向 ESM 暴露一个不可变的默认导出</h4>

<p>使用 Babel 或 Webpack，我们通常将 CJS 重构为 ESM，如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// CJS</span>
</span><span class='line'><span class="kr">const</span> <span class="p">{</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">);</span>
</span><span class='line'><span class="c1">// ESM</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;c&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>再一次地，他们的语法看起来很相似，但忽略了 CJS 中没有命名导出的事实。只有一个叫做 <code>default</code> 的导出，等同于在 CJS 模块完成计算后一个不可变的 <code>module.exports</code> 。从技术上讲，有可能将 <code>module.exports</code> 解构成命名导入，但这需要对标准作更大的变更。<a href="https://github.com/bmeck/node-eps/blob/a1eab9bf023bbe13a79ddb18f0622a5d57215f9b/002-es-modules.md#461-default-imports">这就是现在 CTC 决定采取这种方式的原因</a>。</p>

<h4>4.模块范围的变量类似 <code>module</code>，<code>require</code> 以及 <code>__filename</code> 在 ESM 不存在</h4>

<p>Node.js 和浏览器会实现一些 ESM 的特性，<a href="https://github.com/whatwg/html/issues/1013">但标准化过程仍在进行中</a>。</p>

<p>鉴于将 CJS 和 ESM 集成到一个运行时的工程挑战，CTC 在评估边缘情况和权衡方面做了非常好的工作。比如使用不同的文件扩展名是就是一个很简单的解决方案。</p>

<p>实际上，一个文件扩展名可以认为是一个二进制文件如何解释的提示。如果一个 <code>module</code> 不是 <code>script</code>，我们应该使用不同的文件扩展名。其他工具（如 linter 或 IDE ）也可以获取相同信息。</p>

<p>当然，引入新的文件扩展名有成本，但是一旦服务器和其他应用程序确认 <code>*.mjs</code> 为JavaScript，我们很快就会忘记这个争议。</p>

<h2>将 * .mjs 作为 Node.js 的 Python 3？</h2>

<p>考虑到所有这些限制，人们可能会问，这种过渡将对现在的生态造成什么样的损害。虽然 CTC 会努力解决问题，但社区如何采用这一点仍然存在很大不确定性。这种不确定性 <a href="https://twitter.com/sindresorhus/status/861987349529452545">被众多知名的 NPM 模块作者</a> 再次强调，他们声称将不会在模块中使用 <code>*.mjs</code>。</p>

<p><a href="http://blog.thezerobit.com/2014/05/25/python-3-is-killing-python.html">Python 3 is killing Python</a></p>

<p>很难预测社区如何反应，但是应该不会对现在的生态造成大破坏，甚至能看到从 CJS 平稳过渡到 ESM。主要有两个原因：</p>

<h3>1.与 CJS 严格向后兼容</h3>

<p>那些不喜欢 ESM 的模块作者可以继续使用 CJS，保证自己不被排挤出局。这样他们自己的代码不会受到采用 ESM 的影响，降低迁移到另一个运行时的可能性，让 NPM 迁移到新生态变得容易。从 CJS 到 ESM 的重构给包维护者带来额外工作，不能指望所有人都有时间。</p>

<h3>2. CJS 在 ESM 中的无缝整合</h3>

<p>从 ESM 导入 CJS 模块非常简单。需要注意的是，CJS 仅导出一个默认值。一旦处于 ESM，甚至可能根本不会注意到依赖关系使用的模块风格，尤其是与在 CJS 中使用 <code>await import()</code>相比。</p>

<p>由于 ESM 的这个优点以及其他有点，比如开箱即用的 <a href="https://webpack.js.org/guides/tree-shaking/">tree shaking</a> 和浏览器兼容性，预计在未来几年内，我们可以看到向 ESM 的缓慢而稳定的过渡。CJS 的特性，如动态 <code>require()</code> 和猴子补丁导出，在 Node.js 社区一直是有争议的，不比 ESM 带来的好处。</p>

<h2>这些对我来说意味着什么？</h2>

<p>因为最近这些事情，很容易对目前存在的所有选择和限制感到困惑。在接下来，整理了开发人员面临的典型问题以及我们的回答：</p>

<h3>现在需要重构现有的代码吗？</h3>

<p><strong>不需要</strong>。Node.js 才刚刚开始实现 ESM，仍然有大量的工作要做。<a href="https://medium.com/the-node-js-collection/an-update-on-es6-modules-in-node-js-42c958b890c">James M Snell 预计至少还需要一年时间</a>，还有很多变化的余地，所以现在重构是不安全的。</p>

<h3>应该在新代码中使用 ESM 吗？</h3>

<ul>
<li><strong>如果你已经有或者打算使用像 webpack 这样的构建工具，答案是肯定的</strong>。这将更容易完成代码库的过渡，并使 tree shaking 成为可能。但要小心：一旦 Node.js 支持原生 ESM，可能需要重构其中的一些部分。</li>
<li><strong>如果你正在编写一个库，答案是也肯定的</strong>，你的模块使用者将受益于 tree shaking。</li>
<li><strong>如果你不想进行构建操作，或者正在编写一个 Node.js 应用程序，还是用 CJS 吧</strong>。</li>
</ul>


<h3>现在应该使用 .mjs 吗？</h3>

<p><strong>不要这样做</strong>，目前没有什么好处，工具支持依然薄弱。建议一旦原生 ESM 支持登陆 Node.js，尽快开始迁移。记住，<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types">浏览器只关心 MIME 类型，而不是文件扩展名</a>。</p>

<h3>应该关心浏览器兼容性吗？</h3>

<p>是的，需要在一定程度上关注这个问题。 不应该在导入语句中省略 <code>.js</code> 扩展名，因为浏览器需要完整的 URL，无法像 Node.js 这样执行路径查询。同样，应该避免 <code>index.js</code> 文件。不过，人们并不会很快在浏览器中使用 NPM 软件包，因为仍然不能 bare 导入。</p>

<h3>作为库作者该怎么办？</h3>

<p>用 ESM 编写代码，并使用 <a href="https://rollupjs.org/">Rollup</a> 或 Webpack 转换成单个 CJS 模块，然后在 <code>package.json</code> 将 <code>main</code> 字段指向此 CJS 包，并将 <a href="https://github.com/rollup/rollup/wiki/pkg.module"><code>module</code></a> 字段指向原始 ESM。如果还使用 ESM 之外的其他新语言功能，则应编译成 ES5，并提供 CJS 和 ESM 的打包。这样，你的库用户仍然可以从 tree shaking 获利而无需对代码进行转换。</p>

<p>看一下这些完成 tree shaking 的模块</p>

<h2>总结</h2>

<p>关于 ES 模块有很多不确定性。由于目前 Node.js 在实现上的权衡，开发人员担心可能会破坏 Node.js 的生态。</p>

<p>这些还不会发生，有两个原因：<strong>CJS 的严格的后向兼容和 CJS 在 ESM 中的无缝集成</strong>。</p>

<p>在 Node.js 发布原生 ESM 支持之前，应该仍然使用 Rollup 和 Webpack 等工具。它们在一定程度上模拟了 ESM 环境，但要注意它们不完全符合规范。此外，使用打包仍然是个<a href="https://peerigon.github.io/talks/2016-08-26-jsconf-is-future-frontend-tooling/#36">很好的选择</a>，一旦可以在浏览器中使用 NPM 软件包。</p>

<p>我们 webpack 团队正在努力做一些工作，帮助开发者平稳过渡。为了这个目标，我们计划在 Node.js 的 ESM 支持成熟后，模拟 Node.js 导入 CJS 的方式。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JS/React 开发者的 Atom 终极配置]]></title>
    <link href="http://blog.mirreal.net/blog/2017/05/28/my-atom-editor-setup-for-js-react/"/>
    <updated>2017-05-28T18:00:00+08:00</updated>
    <id>http://blog.mirreal.net/blog/2017/05/28/my-atom-editor-setup-for-js-react</id>
    <content type="html"><![CDATA[<blockquote><p>原文作者：Elad Ossadon</p>

<p>原文链接：<a href="https://medium.com/productivity-freak/my-atom-editor-setup-for-js-react-9726cd69ad20">The Ultimate Atom Editor Setup (+for JS/React)</a></p></blockquote>

<p>根据多年以来不断完善 Sublime Text 配置的经验，决定这次给 Atom 也来一个大改造。这个过程花费了好几个月的时间，但成果还是很卓有成效的，我现在非常满意这份配置。</p>

<p>这份清单将分为实用工具和 React 专用，并涉及到快捷键绑定。</p>

<h2>实用工具</h2>

<h3><a href="https://atom.io/packages/atom-beautify">atom-beautify</a></h3>

<p>可以在 Atom 中 美化 HTML，CSS，JavaScript，PHP，Python，Ruby，Java，C，C ++，C＃，Objective-C，CoffeeScript，TypeScript，Coldfusion，SQL等。</p>

<p>快捷键：<code>⌃+⌥+B</code></p>

<h3><a href="https://atom.io/packages/prettier-atom">prettier-atom</a></h3>

<p>使用 Prettier 来格式化 JavaScript 代码，配有强大的 ESlint 集成。</p>

<p>快捷键：<code>⌃+⌥+F</code></p>

<h3><a href="https://atom.io/packages/atom-transpose">atom-transpose</a></h3>

<p>Atom 的转置更像是字符串翻转。在 Sublime 可以将选中的两个字符串进行交换，看起来更有用。</p>

<p>快捷键：<code>⌥+T</code></p>

<h3><a href="https://atom.io/packages/case-keep-replace">case-keep-replace</a></h3>

<p>使用这个插件可以在替换文本的时候可以保留原来的命名风格。</p>

<p>快捷键：<code>⌘+⌃+R</code></p>

<h3><a href="https://atom.io/packages/change-case">change-case</a></h3>

<p>一个可以快速改变当前选择文本命名方式的工具。比如可以从 <code>camelCase</code> 转换到 <code>snake_case</code> 等。</p>

<p>快捷键：<code>⌘+K ⌘+C/S</code></p>

<h3><a href="https://atom.io/packages/copy-path">copy-path</a></h3>

<p>可以灵活地复制文件路径。</p>

<h3><a href="https://atom.io/packages/duplicate-line-or-selection">duplicate-line-or-selection</a></h3>

<p>重复选择文本或者重复一行，跟 Sublime Text 的行为一致，Atom 可以重复一整行。</p>

<p>快捷键：<code>⌘+⇧+D</code></p>

<h3><a href="https://atom.io/packages/editorconfig">editorconfig</a></h3>

<p>帮助开发人员在不同的编辑器之间保持一致的编码风格。</p>

<h3><a href="https://atom.io/packages/file-icons">file-icons</a></h3>

<p>Atom 的文件特定图标插件，便于区分不同文件类型。</p>

<h3><a href="https://atom.io/packages/git-plus">git-plus</a></h3>

<p>VIM 风格的 git 插件，在没有终端命令行的时候进行提交等其他 git 操作。</p>

<h3><a href="https://atom.io/packages/highlight-selected">highlight-selected</a></h3>

<p>通过双击一个词来高亮整个文件相同的词。</p>

<h3><a href="https://atom.io/packages/local-history">local-history</a></h3>

<p>用于维护本地文件历史的插件（对代码文件进行更改的历史记录）。</p>

<h3><a href="https://atom.io/packages/project-manager">project-manager</a></h3>

<p>轻松访问所有项目，还能对项目特定设置和选项进行管理。</p>

<p>快捷键：<code>⌘+⌃+P</code></p>

<h3><a href="https://atom.io/packages/atom-reveal-file-in-finder">atom-reveal-file-in-finder</a></h3>

<p>可以在工作区或者文件选项卡上打开文件到 Finder 上，快捷命令已经添加到 <code>⌘+⇧*+P</code> 。</p>

<p>快捷键：<code>⌘+⌃+P</code></p>

<h3><a href="https://atom.io/packages/related">related</a></h3>

<p>related 提供了访问与当前打开的文件相关的文件的快速方式。 例如，在 <code>.js</code> 和 <code>.spec.js</code> 文件之间切换。</p>

<p>快捷键：<code>⌘+⇧+ R</code></p>

<p>我的 JS 关联配置 (Menu > Packages > Related > Edit related patterns):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>'([^\\/]+)(?!\\.spec).js(x?)$': [
</span><span class='line'>  'tests/$1.spec.js$2#create',
</span><span class='line'>]
</span><span class='line'>'tests/(.+).spec.js(x?)$': [
</span><span class='line'>  '$1.js$2',
</span><span class='line'>]</span></code></pre></td></tr></table></div></figure>


<h3><a href="https://atom.io/packages/set-syntax">set-syntax</a></h3>

<p>一种简单的命令方式来设置当前文件语法，与 Sublime 类似。</p>

<p>快捷键：<code>⌘+⇧+P</code></p>

<h3><a href="https://atom.io/packages/sort-lines">sort-lines</a></h3>

<p>排序/删除重复行。</p>

<h3><a href="https://atom.io/packages/Sublime-Style-Column-Selection">sublime-style-column-selection</a></h3>

<p>alt +单击跨行选择文本块，每行都有插入符号。</p>

<p>快捷键：<code>⌥+Drag</code></p>

<h3><a href="https://atom.io/packages/tab-foldername-index">tab-foldername-index</a></h3>

<p>可以替换 TAB 标签内容的插件，在打开相同文件名的文件时保证更高的可读性。</p>

<h3><a href="https://atom.io/packages/sync-settings">sync-settings</a></h3>

<p>跨 Atom 实例同步设置，键盘映射，用户样式，初始化脚本，代码段和已安装的软件包。 我将所有设置备份到 Gist 并在工作/个人计算机之间进行同步。</p>

<h3><a href="https://atom.io/packages/toggle-quotes">toggle-quotes</a></h3>

<p>快速切换字符串的单引号和双引号。</p>

<p>快捷键：<code>⌘+⇧+’</code></p>

<h3><a href="https://atom.io/packages/atom-spotify2">atom-spotify2</a></h3>

<p>在 Atom 状态栏中显示在 Spotify 中当前播放歌曲。 不是必要的，但很有趣。</p>

<h2>HTML/CSS/JS/React Specific Packages</h2>

<h3><a href="https://atom.io/packages/atom-ternjs">atom-ternjs</a></h3>

<p>使用 Tern 为 Atom 提供 JavaScript 代码智能提示，支持 ES5，ES6，ES7，Node.js，jQuery，Angular等。</p>

<h3><a href="https://atom.io/packages/atom-wrap-in-tag">atom-wrap-in-tag</a></h3>

<p>为选择的文本增加标签。</p>

<p>快捷键：<code>⌥+⇧+W</code></p>

<h3><a href="https://atom.io/packages/autoclose-html">autoclose-html</a></h3>

<p>自动添加关闭标签。</p>

<h3><a href="https://atom.io/packages/autocomplete-modules">autocomplete-modules</a></h3>

<p>自动补全 <code>require/import</code> 声明。</p>

<h3><a href="https://atom.io/packages/color-picker">color-picker</a></h3>

<p>很厉害的颜色选择器。</p>

<p>快捷键：<code>⌘+⇧+D</code></p>

<h3><a href="https://atom.io/packages/docblockr">docblockr</a></h3>

<p>更容易的方式写文档注释。</p>

<p>使用方式：<code>/** &lt;tab&gt;</code></p>

<h3><a href="https://atom.io/packages/emmet">emmet</a></h3>

<p>一个大大提高 HTML 和 CSS 工作流程的插件。 <a href="http://emmet.io/">关于 Emmet</a></p>

<h3><a href="https://atom.io/packages/emmet-jsx-css-modules">emmet-jsx-css-modules</a></h3>

<p>适用于 css 模块的 emmet 工具。 <code>.foo</code> 现在将扩展为 <code>&lt;div className = {style.foo}&gt; &lt;/ div&gt;</code>，而不是 <code>&lt;div className =“foo”&gt; &lt;/ div&gt;</code>。</p>

<h3><a href="https://atom.io/packages/es6-javascript">es6-javascript</a></h3>

<p>一组专注 ES6，用于优化现代 JavaScript 开发生产力的命令集， 目标是符合 <a href="https://github.com/airbnb/javascript">Airbnb 推荐的代码规范</a>。</p>

<h3><a href="https://atom.io/packages/js-hyperclick">js-hyperclick</a> &amp; <a href="https://atom.io/packages/hyperclick">hyperclick</a></h3>

<p>点击跳到变量或者 import 定义，js-hyperclick 依赖于 hyperclick。</p>

<h3><a href="https://atom.io/packages/pigments">pigments</a></h3>

<p>在项目文件中显示颜色。</p>

<h3><a href="https://atom.io/packages/linter-eslint">linter-eslint</a></h3>

<p>插件 <a href="https://github.com/AtomLinter/Linter">Linter</a> 为 <a href="http://eslint.org/">eslint</a> 提供 UI 接口，用于对 JavaScript 文件进行静态检查。</p>

<h3><a href="https://atom.io/packages/tree-view-copy-relative-path">tree-view-copy-relative-path</a></h3>

<p>允许从 tree view 复制文件的相对路径。</p>

<h3><a href="https://atom.io/packages/lodash-snippets">lodash-snippets</a></h3>

<p>在 Atom 中快速使用 lodash 的代码提示。</p>

<h3><a href="https://atom.io/packages/language-babel">language-babel</a></h3>

<p>支持 JavaScript ES201x，React JSX，Flow和GraphQL语法。</p>

<h3><a href="https://atom.io/packages/react-es7-snippets">react-es7-snippets</a></h3>

<p>React ES7 snippets for atom</p>

<h3><a href="https://atom.io/packages/atom-jest-snippets">atom-jest-snippets</a></h3>

<p>Jest 测试提示</p>

<h2>我的主题</h2>

<h3>UI Theme: <a href="https://atom.io/themes/one-dark-ui">one-dark-ui</a></h3>

<h3>Syntax Theme: <a href="https://atom.io/themes/dracula-theme">dracula-theme</a></h3>

<h2>Install EVERYTHING!</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apm install atom-beautify prettier-atom atom-spotify2 atom-transpose case-keep-replace change-case copy-path duplicate-line-or-selection editorconfig file-icons git-plus highlight-selected local-history project-manager related set-syntax atom-reveal-file-in-finder sort-lines sublime-style-column-selection tab-foldername-index sync-settings toggle-quotes atom-wrap-in-tag atom-ternjs autoclose-html autocomplete-modules color-picker docblockr emmet emmet-jsx-css-modules es6-javascript js-hyperclick hyperclick pigments linter-eslint tree-view-copy-relative-path lodash-snippets language-babel react-es7-snippets atom-jest-snippets one-dark-ui dracula-theme</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[科学上网的方法和原理]]></title>
    <link href="http://blog.mirreal.net/blog/2016/06/10/the-method-and-principle-of-breaking-the-wall/"/>
    <updated>2016-06-10T18:15:50+08:00</updated>
    <id>http://blog.mirreal.net/blog/2016/06/10/the-method-and-principle-of-breaking-the-wall</id>
    <content type="html"><![CDATA[<p>逗你呢，这里没有你想要的东西。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用 ES6 的浏览器兼容性问题]]></title>
    <link href="http://blog.mirreal.net/blog/2016/05/14/compatibility-problem-with-es6/"/>
    <updated>2016-05-14T16:35:34+08:00</updated>
    <id>http://blog.mirreal.net/blog/2016/05/14/compatibility-problem-with-es6</id>
    <content type="html"><![CDATA[<p>以前对浏览器兼容性问题只是大概知道一些点，没想到这次真正着手去做的时候，还是碰到了很多问题。刚开始的时候一边解决问题，一边想着：用 IE8 的都是神经病，到后来，我发现完了，I LOVE IE。</p>

<h2>0x00 起源</h2>

<p>在这次做小蜜 PC 版的时候，由于早于 PC 版，无线版已经重新设计了全新版，做了很多架构上的优化调整。所以在做的时候把无线版的前端架构拿了过来，主要的考虑就是品牌和功能保持跟无线版统一的同时，技术上也可相互支持以及组件复用。</p>

<p>无线版整个架构设计是同事做的，技术上主要采用 ES6 + Webpack + Babel 的方式，由于项目的独特性和特殊需求，并没有使用任何框架，只引入 zepto 作为一个标准支撑库。</p>

<p>而 PC 版的架构跟无线版基本保持一致，主要是把 zepto 换成了 jQuery。</p>

<p>下面是一些基本的开发依赖：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;babel-core&quot;</span><span class="p">:</span> <span class="s2">&quot;~6.3.15&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;babel-loader&quot;</span><span class="p">:</span> <span class="s2">&quot;~6.2.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;babel-preset-es2015&quot;</span><span class="p">:</span> <span class="s2">&quot;~6.3.13&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;babel-preset-stage-0&quot;</span><span class="p">:</span> <span class="s2">&quot;~6.3.13&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;babel-runtime&quot;</span><span class="p">:</span> <span class="s2">&quot;~6.3.13&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;extract-text-webpack-plugin&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.9.1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;less-loader&quot;</span><span class="p">:</span> <span class="s2">&quot;~2.2.1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;nunjucks-loader&quot;</span><span class="p">:</span> <span class="s2">&quot;~1.0.7&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;style-loader&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.10.2&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;webpack&quot;</span><span class="p">:</span> <span class="s2">&quot;~1.12.9&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;webpack-dev-server&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.10.1&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>0x01 polyfill</h2>

<p>由于 Babel 默认只转换转各种 ES2015 语法，而不转换新的 API，比如 Promise，以及 Object.assign、Array.from 这些新方法，这时我们需要提供一些 ployfill 来模拟出这样一个提供原生支持功能的浏览器环境。</p>

<p>主要有两种方式：<code>babel-runtime</code> 和 <code>babel-polyfill</code>。</p>

<h3>babel-runtime</h3>

<p>babel-runtime 的作用是模拟 ES2015 环境，包含各种分散的 polyfill 模块，我们可以在自己的模块里单独引入，比如 promise：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="s1">&#39;babel-runtime/core-js/promise&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>它们不会在全局环境添加未实现的方法，只是这样手动引用每个 polyfill 会非常低效，我们可以借助 <code>Runtime transform</code> 插件来自动化处理这一切。</p>

<p>首先使用 npm 安装：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>npm install babel-plugin-transform-runtime --save-dev
</span></code></pre></td></tr></table></div></figure>


<p>然后在 webpack 配置文件的 babel-loader 增加选项：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">loader</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;babel-loader&quot;</span><span class="p">],</span>
</span><span class='line'><span class="nx">query</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>  <span class="s2">&quot;transform-runtime&quot;</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nx">presets</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;es2015&#39;</span><span class="p">,</span> <span class="s1">&#39;stage-0&#39;</span><span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>babel-polyfill</h3>

<p>而 <code>babel-polyfill</code> 是针对全局环境的，引入它浏览器就好像具备了规范里定义的完整的特性，一旦引入，就会跑一个 <code>babel-polyfill</code> 实例。用法如下：</p>

<p>1.安装 babel-polyfill</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>npm install babel-polyfill --save
</span></code></pre></td></tr></table></div></figure>


<p>2.在入口文件中引用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="s1">&#39;babel-polyfill&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>小结：</h3>

<p>其实做到这些，在大部分浏览器就可以正常跑了，但我们做的是一个用户环境很不确定的产品，对一些年代久远但又不容忽视的运行环境，比如 IE8，我们做的还不够。</p>

<p>接下来将开始讲述我们在兼容性方面遇到的一些问题，和解决方法。</p>

<h2>0x02 开始在 IE8 运行</h2>

<p>最开始做的时候并没有针对 IE 做一些兼容性方面的处理，结果在 IE8 上一跑一堆问题。</p>

<p>第一步，我们把 <code>jQuery</code> 换成 1.12.1 ，因为 2.X 已经不再支持 IE8。</p>

<p>但并没有像我们想象中的那样，只是简单换一下 <code>jQuery</code> 版本就可以正常运行了。</p>

<h2>0x03 default or catch</h2>

<p>这是遇到的第一个问题。在兼容性测试过程中，对下面的代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">_interopRequireDefault</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">__esModule</span> <span class="o">?</span> <span class="nx">obj</span> <span class="o">:</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">obj</span> <span class="p">};</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>或者这种：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">_main2</span><span class="p">.</span><span class="k">default</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 IE8 下会直接报”缺少标识符、字符串或数字”的错。</p>

<p>我们得在对象的属性上加 <code>''</code> 才可以。就像下面这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">_interopRequireDefault</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">__esModule</span> <span class="o">?</span> <span class="nx">obj</span> <span class="o">:</span> <span class="p">{</span> <span class="err">‘</span><span class="k">default</span><span class="err">’</span><span class="o">:</span> <span class="nx">obj</span> <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">_main2</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>至于原因，并不是 IE8 下对象的属性必须得加 <code>''</code> 才行，而是 <code>default</code> 的问题，作为一个关键字，同样的问题还包括 <code>catch</code>。</p>

<p>这两种情况，可以通过使用 <code>transform-es3-property-literals</code> 和 <code>transform-es3-member-expression-literals</code> 这两个插件搞定。</p>

<p>总之，在平时写代码的时候避免使用关键字，或者保留字作为对象的属性值，尤其是在习惯不加引号的情况下。相关讨论：<a href="https://github.com/airbnb/javascript/issues/61">Allow reserved words for properties</a></p>

<h2>0x04 es5-shim、es5-sham</h2>

<p>为了兼容像 IE8 这样的老版本浏览器，我们引入 <code>es5-shim</code> 作为 polyfill。</p>

<p>但在遇到 <code>Object.defineProperty</code> 仍提示 &ldquo;对象不支持此操作&rdquo;</p>

<blockquote><p>As currently implemented, the Object.defineProperty shim will not install on IE8 because IE8 already has such a method. However, the built-in IE8 method only works when applied to DOM objects.</p></blockquote>

<p>其实 es5-shim 明确说明，这个方法的 polyfill 在 IE8 会失败，因为 IE8 已经有个同名的方法，但只是用于 DOM 对象。</p>

<p>同样的问题还包括 <code>Object.create</code>，上述问题可以再引入 es5-sham 解决.</p>

<h2>0x05 addEventListener</h2>

<p>项目中有部分代码直接使用 <code>addEventListener</code> 这个 API，但在 IE8 下的事件绑定并不是这个方法。</p>

<p>这个问题很容易解决，也无需去写额外的 polyfill。我们已经把 jQuery 换成 1.x，所以只需把代码中 <code>addEventListener</code> 换成 <code>jQuery</code> 的写法就 Okay 了。</p>

<p><code>jQuery</code> 其实为我们封装了很多 API，并做了很多兼容性的封装，类似的只要使用封装好的就可以了。</p>

<h2>0x06 无法获取未定义或 null 引用的属性</h2>

<p>这个问题是在特定场景下【转人工】出现的，出现问题的不是 IE8，而是 IE9 和 IE10。</p>

<p>原因是 ocs 实例创建失败，因为没有调用父类的构造函数。</p>

<p>通过安装 <code>transform-es2015-classes</code> 和 <code>transform-proto-to-assign</code> 解决。</p>

<p>在配置项加上这两个插件的配置：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;plugins&quot;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">[</span><span class="s2">&quot;transform-es2015-classes&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;loose&quot;</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}],</span>
</span><span class='line'>      <span class="s2">&quot;transform-proto-to-assign&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>0x07 postMessage</h2>

<p>虽然 <code>postMessage</code> 是 HTML5 的特性，但 IE8 和 Firefox3 很早就实现了这个 API，当然，跟后来的标准并不一致。这其实也不能怪 IE8。</p>

<blockquote><p>The postMessage method is supported in Internet Explorer from version 8, Firefox from version 3 and Opera from version 9.5.</p></blockquote>

<p>我们可能会这样去使用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">parent</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="nx">success</span><span class="o">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="err">‘</span><span class="nx">mirreal</span><span class="err">’</span><span class="p">},</span> <span class="err">‘</span><span class="o">*</span><span class="err">’</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是为了兼容 IE8，我们得转成字符串：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">parent</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">success</span><span class="o">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;mirreal&quot;</span><span class="p">}),</span> <span class="err">‘</span><span class="o">*</span><span class="err">’</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>另外一个需要注意的点是：在 IE8 下 <code>window.postMessage</code> 是同步的。</p>

<blockquote><p>window.postMessage is syncronouse in IE 8</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">syncronouse</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">syncronouse</span><span class="p">);</span> <span class="c1">// 在 IE8 下会在控制台打印 true</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">syncronouse</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>0x08 IE8/IE9 的控制台</h2>

<p>遇到一个奇怪的问题，在刚开始遇到的时候（其实搞清楚原因，好像也挺正常的），小蜜在 IE8 IE9 无法加载。在 IE8 那个古老浏览器的左下角，好像也是唯一会在页面提示脚本错误的浏览器，提示 <code>script error</code>。</p>

<p>第一反应就是应该又是某个函数在 IE 下不支持，准备打开控制台看看到底哪里报错，结果却什么事都没有了，页面竟然顺畅地加载出来了，这下该怎么调试好呢？</p>

<p>开始思考：什么东西是依赖控制台而存在的，到底会是什么呢。。。其实就是控制台本身。</p>

<p>原因就是我们在代码中添加了一些控制信息会打印在控制台，而 IE8/IE9 要开启 IE Dev Tools 才能使用 <code>console</code> 对象。</p>

<p>切忌把 IE8/9 想成 Chrome/Firefox，以为永远有 <code>window.console</code> 可用.终于，IE10 改邪归正，<code>console</code> 不再像段誉的六脉神剑时有时无。</p>

<blockquote><p>console.log is there in IE8, but the console object isn&rsquo;t created until you open DevTools. Therefore, a call to console.log may result in an error, for example if it occurs on page load before you have a chance to open the dev tools.</p></blockquote>

<p>但只要 IE8/9 还在一天，console 检查还是不能少的</p>

<p>事实上，IE8/9 从未死去，所以，得写成这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">console</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;log here&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>要是有一堆 <code>console.log</code>, <code>console.count</code>, <code>console.error</code>, <code>console.time</code>, <code>console.profile</code>，&hellip; 这样去写，那还不把人写到恶心死。</p>

<p>写个简单的 console polyfill 吧，检测是否存在 <code>console</code>，不存在可以创见一个同名的空方法达到不报错的目的。当然，生产环境的代码其实也不会有那么多奇奇怪怪的 <code>console</code>。</p>

<h2>0x09 定义文档兼容性</h2>

<p><code>X-UA-Compatible</code> 当初是针对 IE8 新加的一个配置。用于为 IE8 指定不同的页面渲染模式，比如使用 IE7 兼容模式，或者是采用最新的引擎。</p>

<p>现在基本也不需要前者的降级模式，更多的是写入 <code>IE=edge</code> 支持最新特性。而 <code>chrome=1</code> 则会激活 Google Chrome Frame，前提是你的 IE 安装过这个插件。</p>

<p>有什么用呢，当然有用，有些 API 是作为新特性存在于 IE8 中的，比如 <code>JSON</code>，不开启的话就用不了。</p>

<h3>为什么要用 X-UA-Compatible？</h3>

<p>在 IE8 刚推出的时候，很多网页由于重构的问题，无法适应较高级的浏览器，所以使用 <code>X-UA-Compatible</code> 强制 IE8 采用低版本方式渲染。</p>

<p>比如：使用下面这段代码后，开发者无需考虑网页是否兼容 IE8 浏览器，只要确保网页在 IE6、IE7 下的表现就可以了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content=</span><span class="s">&quot;IE=EmulateIE7&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>而这段代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content=</span><span class="s">&quot;IE=edge,chrome=1&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>IE=edge</code> 告诉 IE 使用最新的引擎渲染网页，<code>chrome=1</code> 则可以激活 Chrome Frame[1]。</p>

<h2>0x0a 条件注释 or 条件编译</h2>

<p>最后说说 IE 的条件注释，用法如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>!    [if !IE]    The NOT operator. This is placed immediately in front of the feature, operator, or subexpression to reverse the Boolean meaning of the expression.
</span><span class='line'>
</span><span class='line'>lt    [if lt IE 5.5]  The less-than operator. Returns true if the first argument is less than the second argument.
</span><span class='line'>
</span><span class='line'>lte   [if lte IE 6]   The less-than or equal operator. Returns true if the first argument is less than or equal to the second argument.
</span><span class='line'>
</span><span class='line'>gt    [if gt IE 5]    The greater-than operator. Returns true if the first argument is greater than the second argument.
</span><span class='line'>
</span><span class='line'>gte   [if gte IE 7]   The greater-than or equal operator. Returns true if the first argument is greater than or equal to the second argument.
</span><span class='line'>
</span><span class='line'>( )   [if !(IE 7)]    Subexpression operators. Used in conjunction with boolean operators to create more complex expressions.
</span><span class='line'>
</span><span class='line'>&amp; [if (gt IE 5)&amp;(lt IE 7)]    The AND operator. Returns true if all subexpressions evaluate to true
</span><span class='line'>
</span><span class='line'>| [if (IE 6)|(IE 7)]  The OR operator. Returns true if any of the subexpressions evaluates to true.
</span></code></pre></td></tr></table></div></figure>


<p>另外一个类似的东西是在 Javascript 中的条件编译（conditional compilation）。我们可以使用这段简单的代码来做浏览器嗅探：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">isIE</span> <span class="o">=</span> <span class="cm">/*@cc_on!@*/</span><span class="kc">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>在其他浏览器中，false 前的被视为注释，而在 IE 中，<code>/*@cc_on .... @*/</code> 之间的部分可以被 IE 识别并作为程序执行，同时启用 IE 的条件编译。</p>

<p>常用变量如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>* @_win32 如果在 Win32 系统上运行，则为 true。
</span><span class='line'>* @_win16 如果在 Win16 系统上运行，则为 true。
</span><span class='line'>* @_mac 如果在 Apple Macintosh 系统上运行，则为 true。
</span><span class='line'>* @_alpha 如果在 DEC Alpha 处理器上运行，则为 true。
</span><span class='line'>* @_x86 如果在 Intel 处理器上运行，则为 true。
</span><span class='line'>* @_mc680x0 如果在 Motorola 680x0 处理器上运行，则为 true。
</span><span class='line'>* @_PowerPC 如果在 Motorola PowerPC 处理器上运行，则为 true。
</span><span class='line'>* @_jscript 始终为 true。
</span><span class='line'>* @_jscript_build 包含 JavaScript 脚本引擎的生成号。
</span><span class='line'>* @_jscript_version 包含 major.minor 格式的 JavaScript 版本号。
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Internet Explorer 11 之前的所有版本的 Internet Explorer 都支持条件编译。  从 Internet Explorer 11 标准模式开始，Windows 8.x 应用商店应用不支持条件编译。</p></blockquote>

<h2>后：</h2>

<p>之前一直在做移动端的开发，没想到做 PC 端也会遇到这么多的兼容性问题。不同于移动端设备的繁杂和不确定性，PC 版的兼容更侧重于对特定浏览器的特性的了解，相比而言更为明确，而非因为某一款手机的诡异表现。</p>

<h2>参考文档：</h2>

<p><a href="https://github.com/airbnb/javascript/issues/61">Allow reserved words for properties</a></p>

<p><a href="https://github.com/es-shims/es5-shim/issues/5">IE8 defineProperty/getOwnPropertyDescriptor clash with shim</a></p>

<p><a href="http://babeljs.io/docs/plugins/transform-runtime/">Runtime transform</a></p>

<p><a href="https://github.com/babel/babel/blob/master/packages/babel-plugin-transform-runtime/src/definitions.js">babel-plugin-transform-runtime definitions</a></p>

<p><a href="https://github.com/babel/babelify/issues/133">super() not calling parent&rsquo;s constructor on IE9</a></p>

<p><a href="http://help.dottoro.com/ljgheukc.php">postMessage method (window) Javascript</a></p>

<p><a href="https://msdn.microsoft.com/library/gg589530(v=vs.85">使用 F12 工具控制台查看错误和状态</a>.aspx)</p>

<p><a href="https://msdn.microsoft.com/zh-cn/library/cc288325(v=vs.85">定义文档兼容性</a>.aspx)</p>

<p><a href="https://msdn.microsoft.com/zh-cn/library/121hztk3(v=vs.94">条件编译 (JavaScript)</a>.aspx)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[为什么是 JSONP]]></title>
    <link href="http://blog.mirreal.net/blog/2016/04/01/what-is-jsonp-and-why/"/>
    <updated>2016-04-01T21:06:58+08:00</updated>
    <id>http://blog.mirreal.net/blog/2016/04/01/what-is-jsonp-and-why</id>
    <content type="html"><![CDATA[<!-- # JSONP，跨域，安全策略，以及 WHY

服务器端、浏览器端

原生实现，包装 Api

同步请求？异步请求

文件上传

安全，跨域问题 -->


<h2>AJAX、JSON、JSONP</h2>

<p>在 WEB 开发中，经常见到诸如 AJAX、JSON、JSONP 这些词，但这三种东西到底是什么，又有什么关系和区别。</p>

<h3>AJAX （Asynchronous JavaScript + XML）</h3>

<blockquote><p>Ajax isn’t a technology. It’s really several technologies, each flourishing in its own right, coming together in powerful new ways. Ajax incorporates:</p><p>* standards-based presentation using XHTML and CSS;<br/>* dynamic display and interaction using the Document Object Model;<br/>* data interchange and manipulation using XML and XSLT;<br/>* asynchronous data retrieval using XMLHttpRequest;<br/>* and JavaScript binding everything together.</p><footer><strong>Jesse James Garrett,</strong> <cite><a href='http://adaptivepath.org/ideas/ajax-new-approach-web-applications/'>Ajax: A New Approach to Web Applications</a></cite></footer></blockquote>


<p>异步 JavaScript + XML, 本身不是一种技术, 是在2005年由 Jesse James Garrett 提出的一个术语, 描述了一种结合使用大量已有技术的方式, 包括: HTML 或 XHTML, CSS, JavaScript, DOM, XML, XSLT, 还有最重要的 XMLHttpRequest 对象.</p>

<p>尽管在 AJAX 中 X 代表 XML, 但现在 JSON 使用的更多，因为 JSON 具有很多优势，比如更轻量并且是 JavaScript 的一部分. 在 AJAX 模型中 JSON 和 XML 都用于承载信息.</p>

<h3>JSON（Javascript Object Notation）</h3>

<p>JSON 是一种轻量级的数据交换格式。由道格拉斯·克罗克福特（Douglas Crockford）在 2012 年发明，并逐渐取代 XML 成为事实上的数据交换格式标准。</p>

<p>JSON 基于 JavaScript Programming Language, Standard ECMA-262 3rd Edition - December 1999的一个子集。但采用完全独立于语言的文本格式，并使用了类似于 C 语言家族的习惯。</p>

<p>在 JSON 中，一共 6 种数据类型：</p>

<ul>
<li>number：跟 Javascript 的数值一致，除去未曾使用的八进制与十六进制格式，和一些编码细节</li>
<li>boolean：<code>true</code> 和 <code>false</code></li>
<li>string：是由双引号包围的任意数量Unicode字符的集合，使用反斜线转义</li>
<li>null：<code>null</code></li>
<li>array：数组是值（value）的有序集合。一个数组以“[”（左中括号）开始，“]”（右中括号）结束，值之间使用“,”（逗号）分隔</li>
<li>object：对象是一个无序的“‘名称/值’对”集合。一个对象以“{”（左括号）开始，“}”（右括号）结束，每个“名称”后跟一个“:”（冒号）；“‘名称/值’ 对”之间使用“,”（逗号）分隔</li>
</ul>


<p>以及上面的任意组合。</p>

<p>在 javascript 中有一个全局的对象 JSON，包含两个方法 <code>JSON.stringify()</code> 和 <code>JSON.parse()</code>，用于序列化和解析 JSON。</p>

<h3>JSONP（JSON with Padding）</h3>

<p>最初是开发者为了解决跨域问题搞出来的一个颇为奇怪的东西，产生原因和名字一样古怪，光听名字恐怕没几个人知道说的是个什么东西。</p>

<p>因为 ajax 请求收到同源策略的限制不允许跨域访问，而在实际开发中又常常会有类似的需求。</p>

<p>刚好 <code>&lt;script&gt;</code> 标签可以引用其他站点的静态资源，想想我们有时候在站点引入的数据统计类的 js。</p>

<p>但我们要的是数据，而不是一段静态代码，怎么办？</p>

<p>这还不简单吗，让服务器动态生成 js ，再把数据放进去不就可以吗。为了区分不数据，还需要针对返回的数据做一个标识，其实就是在数据外面包裹一个函数名。</p>

<p>然后需要浏览器端预先设置好这样一个函数，返回的数据就相当于一次执行过程，对获取数据的处理。</p>

<h3>总结</h3>

<ol>
<li>AJAX 是一类技术的集合，其中最重要的是 <code>XMLHttpRequest</code></li>
<li>JSON 是一个数据交换格式</li>
<li>JSONP 是为了解决跨域问题搞出来的一种获取数据的方式</li>
</ol>


<h2>下面举个栗子</h2>

<h3>服务器</h3>

<p>这里使用 node 返回一段简单的数据。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * 一个简单的 http 服务器,返回 json 数据</span>
</span><span class='line'><span class="cm"> * 跟 node 主页上的那个经典例子没太大差别</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">urllib</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">9999</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="o">:</span> <span class="s1">&#39;Mirreal&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="o">:</span> <span class="s1">&#39;24&#39;</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">urllib</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">query</span> <span class="o">&amp;&amp;</span> <span class="nx">params</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span>  <span class="nx">params</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">callback</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span> <span class="c1">// jsonp</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/javascript&#39;</span> <span class="p">});</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span> <span class="c1">// 普通的json</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;server is listening on port &#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>浏览器</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// zepto 的写法</span>
</span><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://127.0.0.1:9999&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">_input_charset</span><span class="o">:</span> <span class="s1">&#39;utf-8&#39;</span> <span class="p">},</span>
</span><span class='line'>  <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">timeout</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">context</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Ajax error!&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样就很轻松的通过 JSONP 的方式获取到数据，我们也不需要关心里面究竟是怎么一回事，但经常会有人问起像“为什么 jsonp 不能使用 POST 方法”的问题，其实稍微了解一下 JSONP 的原理，这种问题完全就不存在了。</p>

<p>虽然像 jQuery 这类库将 jsonp 封装到 Ajax 上，但准确来讲是不对的。因为 jsonp 只是通过动态地通过 <code>&lt;script&gt;</code> 标签去请求一段 js 代码（或者叫数据），而非使用 XMLHttpRequest ，原理就像下面这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * 对 jsonp 的一种简单封装</span>
</span><span class='line'><span class="cm"> * @param {Object} options</span>
</span><span class='line'><span class="cm"> * @returns null</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">getJsonp</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">callbackName</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">callbackName</span><span class="p">;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">scriptElem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">scriptElem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;?callback=&#39;</span> <span class="o">+</span> <span class="nx">callbackName</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">scriptElem</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">delete</span> <span class="nb">window</span><span class="p">[</span><span class="nx">callbackName</span><span class="p">];</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">scriptElem</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;load error&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">delete</span> <span class="nb">window</span><span class="p">[</span><span class="nx">callbackName</span><span class="p">];</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">window</span><span class="p">[</span><span class="nx">callbackName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 调用</span>
</span><span class='line'>  <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">scriptElem</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这段代码对 JSONP 进行一层简单包装，调用也很简单：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">getJsonp</span><span class="p">({</span>
</span><span class='line'>  <span class="s1">&#39;url&#39;</span><span class="o">:</span> <span class="s1">&#39;http://127.0.0.1:9999/&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;callbackName&#39;</span><span class="o">:</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;success&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;我是回调函数,我拿到数据了&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>看上去代码还挺长的，实际上核心代码不多，分三步：</p>

<h4>1.创建一个 <code>&lt;script&gt;</code> 标签，并设置其 url</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">scriptElem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">scriptElem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;?callback=&#39;</span> <span class="o">+</span> <span class="nx">callbackName</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>2.设置回调函数</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nb">window</span><span class="p">[</span><span class="nx">callbackName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里简单处理，直接把传入的回调函数设置成全局的</p>

<h4>3.调用</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">scriptElem</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>实际上就是把 <code>&lt;script&gt;</code> 加到 html 文档中，这样就会去加载标签的内容，也就是一个 js 文件。</p>

<p>但通常现实中跑的代码内容会更多，包含一些错误控制、参数拼接、超时处理、性能安全等方面的，但它仍然清楚地描述 JSONP 的原理。</p>

<h2>安全</h2>

<p>早期的浏览器处于安全层面的考量，使用同源策略，限制了一个源（origin）中加载文本或脚本与来自其它源（origin）中资源的交互方式。</p>

<p>但是随着互联网的发展催生了跨域访问进行数据交互的需求，于是 JSONP 就产生了，以及后来的 CORS 机制，允许 XMLHttpRequest 对象发起跨域的请求。</p>

<p>但是另一方面，也增加了安全风险，我们在使用的时候应当更加谨慎小心，防止 XSS、CSRF 等攻击。</p>

<!-- JSONP 的安全问题通常属于 CSRF（ Cross-site request forgery 跨站请求伪造）攻击范畴。 -->


<h2>其他</h2>

<h3>数据预览</h3>

<p>之前碰到一个问题，为什么调用一些接口返回的数据无法使用 Chrome 预览，我自己写测试接口的时候也碰到过。其实这里完全没有什么技术可言，只是因为没有在 response 头部加上 <code>Content-Type: application/javascript</code>，仅此而已。</p>

<h2>参考文档</h2>

<ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/AJAX">AJAX | MDN</a></li>
<li>Jesse James Garrett 的文章：<a href="http://adaptivepath.org/ideas/ajax-new-approach-web-applications/">Ajax: A New Approach to Web Applications</a></li>
<li><a href="http://www.json.org/json-zh.html">JSON</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2015 to 2016]]></title>
    <link href="http://blog.mirreal.net/blog/2016/03/07/2015-to-2016/"/>
    <updated>2016-03-07T16:54:15+08:00</updated>
    <id>http://blog.mirreal.net/blog/2016/03/07/2015-to-2016</id>
    <content type="html"><![CDATA[<p>在这个时间写点东西，不知道会不会显得太晚。</p>

<p>我时常会陷入一种没有故事的境地，究根问底，大概是从来没有很迫切地去争取什么，什么才是我的东西，我好想并不是很清楚，我要拿到什么东西，我依然不明白。</p>

<p>当然，这样过得，也过得下去，只是当回首的时候，好像什么事都没有发生过一样。</p>

<p>现在的我，跟去年的我似乎并没有太大差别，不同的是，也许显得沧桑些许。</p>

<p>曾经我会想，等到我拿到一个真正值得拿出手的成就，我一定要大声告诉所有朋友，所有认识的人，我不差。</p>

<p>那些看重我，或者是看轻我的人，我想告诉这个世界，这个家伙并不是一个废物。</p>

<p>但，这个情景迟迟未出现，我还是像个废物似的活着，不断地陷入废物理论，难以自拔。</p>

<p>我走着走着，发现，即使是最亲近的人，也正在离我远去，我想，由他们去吧，我继续漂泊，无依的生活，就这样苟且着。</p>

<p>在某个世界的角落里，就这样一个人活着。</p>

<p><br><br></p>

<p>上天也曾带我不薄，赐予我最美丽的邂逅，并度过了一段最快乐的时光。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[我是怎么成了一名程序员]]></title>
    <link href="http://blog.mirreal.net/blog/2015/05/06/how-to-be-a-programmer/"/>
    <updated>2015-05-06T20:55:13+08:00</updated>
    <id>http://blog.mirreal.net/blog/2015/05/06/how-to-be-a-programmer</id>
    <content type="html"><![CDATA[<p>程序员是这个世界给我们这种以写代码为生的一类人的一种称谓，然而，我们还不得不接受，如果可以，我们更愿意换个名字。</p>

<p>读高中时接触到电脑报，开始了解计算机的一些东西，虽然初中时也上过“微机”课，但基本只是形式上的，接触一下计算机罢了，那时候机房的电脑装的是Windows 98，上课时都在玩游戏，泡泡龙，抢滩登陆。</p>

<p>高中时期，阅读报纸更像是学习之外的娱乐，生活本来就很乏味。但是，我没有自己的电脑，也没有学习过编程语言。高二的时候，有了自己的第一部手机，诺基亚5320XM，那时候iPhone还没成为街机，没进入中国，当然水货总是有的，市面上也只有屈指可数的几款Android手机。总之，此时触摸时代仍未到来。</p>

<!-- more -->


<p>有了一部手机，就可以接入互联网，一窥这个信息爆炸的世界。甚至沉迷于手机，就像现在许多的低头一族，虽然那时候手机应用其实真不多，很多用手机的人只是将其作为打电话的工具。移动互联网，貌似还没有这个东西，但我不那么看，我从一开始就不是为了打电话，现在的人应该会理解。</p>

<p>然后，进入大学，好像整个世界都不同了，离开家乡，来到陌生的城市。在大一下学期时，学习C++，第一次接触到编程语言，还上过计算机网络课。但当时就是什么都不懂，即使期末考试拿到90分，但实际上仍然比一无所知好不了多少。</p>

<p>后来就放任自流了，大学生活是很轻松的，什么压力都没有，如果你想，你可以大不一样，你也可以毫无长进。意识到这点并不困难，难的是在这种可能无人指点的情况下突围。大二开始讲了数据结构课，老师是大一讲离散数学的那位，那时老师说了一句不知是好久不见还是又见面了的话，让我一直觉得好像是昨天发生的事。噢，这时还上了数据库的课，觉得很新鲜，但没觉得好玩，老师其实很不错，可惜当时没能体会到。老师偶然提到曾经创过业，一笔带过，我们似乎也并不在意。后来，老师在13年又创立一家公司，已经完成B轮融资，达到数十人的规模，但仍然来学校上课，这些都是后来得知的。</p>

<p>到了大二下学期，好像没什么有趣的课了。我也开始思考出路，因为突然发现时间不多。记得，在图书馆拿了一本书，HTML5 canvas基础教程。那时候，图书馆讲HTML5还没有几本。大二结束的那个暑假，我借了一堆书回家，有canvas那本，有head first HTML5，有论道HTML5，还有几本貌似，这是我第一次这么干，直接从应用入手，并依葫芦画瓢，写了人生中第一个游戏，代号moon9。这个暑假，过得很充实，虽然大部分时间都呆在家里，看书，敲代码。</p>

<p>大三开始的时候，我给自己定下一个小目标，每周读一本书，无所谓类型，漫画都可以。也就是因为这个小小的决定，我找到了许多好玩的东西。黑客与画家，罗素的故事就是这时候读的，我还记得那时在英国文学那栏乱翻，也不知道为什么就拿起这本书，虽然这本书本不该归类到英国文学，我因此开始了解数理逻辑这个全新的领域，然后我去了解哥德尔，维特根斯坦，图灵，冯诺依曼。我经常在课余时间跑去图书馆，一方面发现新的好书，一方面完成每周的阅读计划，有时候同时读几本书。这个学期，绝对是一个转折点，或者说是从那个暑假开始的。我是从这时候才开始有了阅读的习惯，但一周一本的计划我只坚持了一年，大四的时候找工作的时候不经意的打破计划，但是一有空我仍然会去找书读，跟从前还是大不一样。</p>

<p>转眼大三的第一个学期过去了，上过什么课程已经记不清楚了。寒假，我又带回去好几本书，这时候读了javascript高级程序设计，之前从来没有读过一本讲javascript语法的书，从这时开始才真正了解js。并写下了fling这个游戏。这时候，我对整个web开发也算了解，知道服务器，数据库，HTTP协议这些概念。</p>

<p>大三下，转眼就要到了毕业的时刻，但还有时间。我依然保持着节奏，一边了解一些计算机各个方面的知识，软件工程，游戏AI，机器学习，大数据，许多C语言家族之外的语言，Ruby，Erlang，Scala，Clojure，Haskell，一方面读些看起来毫无用处的书，比如哲学，文学，艺术类，科普，我当然不觉得它们毫无用处。那个暑假，我开始为找工作作准备，虽然对于何去何从仍然毫无头绪，但得准备。我拿了算法，程序员面试攻略，effective javascript，think python，think Java，还有一些阅读计划的书。练习很多算法的例子，重写了fling，写了生命游戏的canvas版，汉诺塔的图形演示。</p>

<p>新学期开学，到了找工作的时候，可惜九月份被学校带到绵阳。国庆之后，开始大规模投简历，第一个面试机会是517na，表现得很糟糕，紧张加之没经验。第二个面试机会，是美团，进入第三个环节，可惜失败了。后来，又参与了好几次面试，并逐渐找到自己的定位，前端。然后，到十一月份，去全微实习。在这里，学到了很多，在自学时学不到的东西。后来，就来到阿里。</p>

<p>其实，主要的学习基本集中在假期，两个暑假，一个寒假，在学校很少有机会连续的学习，更多的随便做些新的尝试。然后，就成为一名程序员，一名前端工程师。</p>

<p>之前看到一篇文章，谈学习编程的年龄，自己二十好几了，现在学习编程难吗。难吗？其实没那么困难，像我这样不是也能写点代码么？</p>

<p>人总是不甘于平庸的，虽然拿到阿里的offer，但只是起点，我知道我欠缺的有很多。没人愿意一辈子无所作为，尤其是在信息技术飞速发展的互联网行业，不更新自己，简直是在自杀。</p>

<p>这两天，翻起笔记本，记录我的一些经历，比如框图，功能，简历。我喜欢一个本子，一支笔，周围尽是凌乱，头脑风暴，把自己想到的通通写下来，这种方法很适合我。在这一年里，反而不怎么使用了，大四的这段时间，好像经历过很多事情。之所以给我这种错觉，我想是因为之前的生活太过于温室化，波澜不惊，我放弃了尝试，所以最后一起扑向我。</p>

<p>我想起那个暑假在家为工作准备的我，肯定没想到后来发生的一切，未来的路还很漫长，谁知道会怎样呢，但是我知道，若是什么都不做的话，会比你想象的更糟糕。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[一个小项目之后]]></title>
    <link href="http://blog.mirreal.net/blog/2015/04/19/a-small-project/"/>
    <updated>2015-04-19T23:11:18+08:00</updated>
    <id>http://blog.mirreal.net/blog/2015/04/19/a-small-project</id>
    <content type="html"><![CDATA[<p>没想到这么快就有了自己负责的一个小项目。</p>

<p>但是，从上周五开始，一直持续到本周五，才基本从中脱离出来。</p>

<p>体会了一把在互联网公司加班的节奏，周六加班，周一到11点，周二到零点，周三干脆没回去，周四正式上线，又到凌晨一点，周五本想多睡会儿，但出现问题，又来到公司。</p>

<p>但是，也有一点收获，接触了一些人。我是个被动的人，平常很少主动去认识别人，但因为工作共同的目标，而有了一点共同的语言，必不可少的沟通。这让我意识到，我仍然是一个普通的人，仍然渴望群体生活，仍然渴望交流沟通，即使本质上是个不擅社交的人。</p>

<!-- more -->


<p>在这次事件中，发现自己有很多问题。
比如在技术上</p>

<ol>
<li>代码风格不统一</li>
<li>耦合度太高</li>
<li>不写注释</li>
<li>没有自己的编程思路</li>
</ol>


<p>这只是一部分，虽然我一直明白自己现在并不是个高手，但没想到还是高估了自己，存在太多问题。</p>

<p>还有，我发现自己没有解决问题的热情，比如某个兼容性问题，听之任之，也没有一套行之有效的解决问题的方法。定位，二分，这些东西当然知道，总嫌麻烦懒得去弄。</p>

<p>说到这里，我发现自己还有明显的拖延症，回避问题，想让时间冲走一切。</p>

<p>我还思考了一些更深层次的原因，比如对于工作。我从来都不是一个工作狂，之前在全微就是，到下班时间就走，虽然我知道大多数老板都不喜欢这样的人。而且，日复一日的工作，重复的事，总会显得枯燥。</p>

<p>我喜欢新鲜的事物，甚至过头了，喜新厌旧。之所以成了一名前端工程师，而不是一个玩电子技术的，就是由于对新鲜事物的一种追求。我追求多个领域的融汇贯通，但对每个领域都不求甚解，抱着一种玩乐的心理，走马观花。</p>

<p>当时为什么选择去图书馆呢，因为需要一种方式来填补因为迷茫造就的空白，而读书，是成本最低的方式。好吧，我承认，我没钱，也没兴趣去扮人偶去赚钱，这个世界很多事情都像体验，却因为钱没有去做。所以，我想告诉后来者，别因为钱放弃你的梦想，因为这真的挺傻的，我现在才发现，只要你敢去想象，钱从来都不是问题，或许只是个借口罢了。</p>

<p>工作的意义在于什么呢，自我价值的体现，人生意义的实现，回到人群中，或者是为了打发这一生，为了报酬，为了生存。我，其实不太明白，我没有过梦想，倒是有些不切世纪的幻想。有时，觉得生活很虚化的，就像此刻，听着雨声，听着柴可夫斯基，思考这些无聊的话题。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[实现不定尺寸图片居中的几种方式]]></title>
    <link href="http://blog.mirreal.net/blog/2015/01/23/image-audo-middle/"/>
    <updated>2015-01-23T21:26:48+08:00</updated>
    <id>http://blog.mirreal.net/blog/2015/01/23/image-audo-middle</id>
    <content type="html"><![CDATA[<p>这是在实习工作中遇到的一个需求，实现未知尺寸的图片在一固定宽高的容器中水平和垂直居中。</p>

<p>比如是在一个 200px 的正方形容器，图片的宽高可能大于 200px，也可能小于 200px。对于小图片，就是简单的水平和垂直居中，而大图片则要求按比例缩放，并实现居中。</p>

<p>这个问题主要有两个方面的点：</p>

<ul>
<li>未知尺寸元素的垂直居中</li>
<li>大图片的宽高适配</li>
</ul>


<p>因为图片大小尺寸未知，且可能超出容器，很多垂直居中的方法不能用。</p>

<h3>最终的解决方法如下：</h3>

<!-- more -->


<p>HTML 大概是这样的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;box&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;img/0.jpg&quot;</span> <span class="na">alt=</span><span class="s">&quot;earth shadow&quot;</span> <span class="na">title=</span><span class="s">&quot;It&#39;s me&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>CSS：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.box</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">width</span><span class="o">:</span> <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">height</span><span class="o">:</span> <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">position</span><span class="o">:</span> <span class="k">relative</span><span class="p">;</span>
</span><span class='line'>  <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.box</span> <span class="nt">img</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
</span><span class='line'>  <span class="k">top</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">right</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">left</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">margin</span><span class="o">:</span> <span class="k">auto</span><span class="p">;</span>
</span><span class='line'>  <span class="k">max-width</span><span class="o">:</span> <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">max-height</span><span class="o">:</span> <span class="m">200px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>将容器的位置设为 <code>relative</code> ，图片的位置设为 <code>absolute</code> ，然后将其 <code>top</code>， <code>right</code>， <code>bottom</code>， <code>left</code> 都设置成0，虽然图片尺寸未知，但是对于一张具体的图片而言是有固定宽高的，所以并不能使它四个方位间距都为0，因此 <code>margin: auto;</code> 会让它居中。如果仅对于宽高都小于200px的图片，这样就足够了，但是对于大图片就不适用，所以再加上 <code>max-width: 200px; max-height: 200px;</code> ，这样图片就可以自适应缩放。</p>

<p>查看演示：<a href="https://mirreal.github.io/demo/image-center/1.html">demo1</a></p>

<h3>方式二：使用表格布局</h3>

<p>还是这段 HTML：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;box1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;img/0.jpg&quot;</span>  <span class="na">alt=</span><span class="s">&quot;earth shadow&quot;</span> <span class="na">title=</span><span class="s">&quot;It&#39;s me&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>CSS这样写：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.box1</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">width</span><span class="o">:</span> <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">height</span><span class="o">:</span> <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">min-width</span><span class="o">:</span> <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">display</span><span class="o">:</span> <span class="k">table-cell</span><span class="p">;</span>
</span><span class='line'>  <span class="k">vertical-align</span><span class="o">:</span> <span class="k">middle</span><span class="p">;</span>
</span><span class='line'>  <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.box1</span> <span class="nt">img</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">max-width</span><span class="o">:</span> <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">max-height</span><span class="o">:</span> <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">vertical-align</span><span class="o">:</span> <span class="k">middle</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>查看演示：<a href="https://mirreal.github.io/demo/image-center/2.html">demo2</a></p>

<h3>方式三：使用背景图片</h3>

<p>HTML就直接写了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;box2&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>CSS：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.box2</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">width</span><span class="o">:</span> <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">height</span><span class="o">:</span> <span class="m">200px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-image</span><span class="o">:</span> <span class="sx">url(img/0.jpg)</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-repeat</span><span class="o">:</span> <span class="k">no-repeat</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-position</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>一个演示：<a href="https://mirreal.github.io/demo/image-center/3.html">demo3</a></p>

<p>直接使用 <code>background-position: center;</code> 实现居中，如图片尺寸小于 200px 就 OK 了。但是对于大图片，会被截掉，所以还需加上 <code>background-size: contain;</code> ，可是对于小图片又有问题，因为加上这个属性会对图片缩放，小图也不例外。而在我们的需求里，对小图要求按照其原有大小显示。</p>

<p>貌似这种方式使用纯 CSS 行不通。</p>

<p>&hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第一次实习生体验]]></title>
    <link href="http://blog.mirreal.net/blog/2014/11/29/my-first-internship/"/>
    <updated>2014-11-29T23:21:08+08:00</updated>
    <id>http://blog.mirreal.net/blog/2014/11/29/my-first-internship</id>
    <content type="html"><![CDATA[<p>实习，也是第一份工作。</p>

<p>一直想对此写点什么。在这段并不是太长的时间里，学到的很多，有些东西可能无法言表，就像是某种潜移默化的影响和变化。</p>

<p>就之前的工作而言，虽说没有遇到什么太复杂的任务，主要是学习和熟悉。但是，真的进入工作环境，才知道很多东西都要花时间，去了解一些具体的特别细节的东西。以前自己学习时候更多的在于逻辑实现，随随便便就算了，哪里想过太多。我也不清楚，我怎么就成了一名前端工程师了。</p>

<!-- more -->


<p>回想最初的学习过程中，花了很多时间去掌握Javascript这门语言，但并非研究其在浏览器中的各种用法。布局这种事，也相当马虎，或者说对CSS从来都没上心，和很多做后端对css的认识类似，完完全全一个新手的姿态。可是，作为一个前端工程师，如果知道的CSS知识比一个后端开发者多不了多少，那未免显得太不合格。</p>

<p>在秋季招聘季之初，和很多人一样显得特别迷茫，不知道该何去何从，投递过很多不同的职位，什么运维，测试，研发，网络都有。在那时候，对前端工程师的理解特别片面和错误，在经过美团面试之后才决定走上前端开发的路。可是，校招这种事就像一阵风一样，来得快去得也快，等到我坚定自己的路线之后，仿佛什么都晚了，虽然我仍在进行各种尝试，可是效果甚微。</p>

<p>那一段时间里，也让我明白一件很重要的事，以前的我太局限于自己的象牙塔，外面的洪荒世界让我不敢踏出。但是呢，早点失败，就可能早点成功，没能勇敢地走出去是大学里最大的遗憾。如果有机会早点接触这个真实的世界，现在我的处境肯定会更好。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Base64简要笔记及其他]]></title>
    <link href="http://blog.mirreal.net/blog/2014/11/06/base64-note/"/>
    <updated>2014-11-06T21:38:01+08:00</updated>
    <id>http://blog.mirreal.net/blog/2014/11/06/base64-note</id>
    <content type="html"><![CDATA[<h3>Base64 是一种基于 64 个可打印字符来表示二进制数据的表示方法。</h3>

<h4>1.base64 算法的由来</h4>

<p>base64 最早是用作解决电子邮件的传输问题，由于历史原因，早期电子邮件只允许传输 ASCII 码字符，如果想传输一封带有非 ASCII 字符的邮件，在遇到一些老旧的网关就可能会对字符最高位进行调整，导致收到的邮件出现乱码。</p>

<h4>2.base64 不是加密算法</h4>

<p>base64 算法的编码和解码方法可以作为加密和解密操作，但是不能叫做加密算法，因为其算法和充当密钥的索引表都是公开的。最多是让在你身后的人一时看不懂，所谓防君子不防小人。</p>

<h4>3.Base 编码方法</h4>

<!-- more -->


<p>转换的时候，将三个 byte 的数据，先后放入一个 24bit 的缓冲区中，先来的 byte 占高位。数据不足 3byte 的话，剩下的 bit 用 0 补足。然后，每次取出 6 个 bit，按照其值选择索引表的字符作为编码后的输出。不断进行，直到全部输入数据转换完成。</p>

<p>这里就不举例说明，具体可以参考维基百科。</p>

<h4>4.base64 索引表如下</h4>

<table>
<tr>
<th scope="col">数值</th>
<th scope="col">字符</th>
<th scope="col">数值</th>
<th scope="col">字符</th>
<th scope="col">数值</th>
<th scope="col">字符</th>
<th scope="col">数值</th>
<th scope="col">字符</th>
</tr>
<tr>
<td>0</td>
<td>A</td>
<td>16</td>
<td>Q</td>
<td>32</td>
<td>g</td>
<td>48</td>
<td>w</td>
</tr>
<tr>
<td>1</td>
<td>B</td>
<td>17</td>
<td>R</td>
<td>33</td>
<td>h</td>
<td>49</td>
<td>x</td>
</tr>
<tr>
<td>2</td>
<td>C</td>
<td>18</td>
<td>S</td>
<td>34</td>
<td>i</td>
<td>50</td>
<td>y</td>
</tr>
<tr>
<td>3</td>
<td>D</td>
<td>19</td>
<td>T</td>
<td>35</td>
<td>j</td>
<td>51</td>
<td>z</td>
</tr>
<tr>
<td>4</td>
<td>E</td>
<td>20</td>
<td>U</td>
<td>36</td>
<td>k</td>
<td>52</td>
<td>0</td>
</tr>
<tr>
<td>5</td>
<td>F</td>
<td>21</td>
<td>V</td>
<td>37</td>
<td>l</td>
<td>53</td>
<td>1</td>
</tr>
<tr>
<td>6</td>
<td>G</td>
<td>22</td>
<td>W</td>
<td>38</td>
<td>m</td>
<td>54</td>
<td>2</td>
</tr>
<tr>
<td>7</td>
<td>H</td>
<td>23</td>
<td>X</td>
<td>39</td>
<td>n</td>
<td>55</td>
<td>3</td>
</tr>
<tr>
<td>8</td>
<td>I</td>
<td>24</td>
<td>Y</td>
<td>40</td>
<td>o</td>
<td>56</td>
<td>4</td>
</tr>
<tr>
<td>9</td>
<td>J</td>
<td>25</td>
<td>Z</td>
<td>41</td>
<td>p</td>
<td>57</td>
<td>5</td>
</tr>
<tr>
<td>10</td>
<td>K</td>
<td>26</td>
<td>a</td>
<td>42</td>
<td>q</td>
<td>58</td>
<td>6</td>
</tr>
<tr>
<td>11</td>
<td>L</td>
<td>27</td>
<td>b</td>
<td>43</td>
<td>r</td>
<td>59</td>
<td>7</td>
</tr>
<tr>
<td>12</td>
<td>M</td>
<td>28</td>
<td>c</td>
<td>44</td>
<td>s</td>
<td>60</td>
<td>8</td>
</tr>
<tr>
<td>13</td>
<td>N</td>
<td>29</td>
<td>d</td>
<td>45</td>
<td>t</td>
<td>61</td>
<td>9</td>
</tr>
<tr>
<td>14</td>
<td>O</td>
<td>30</td>
<td>e</td>
<td>46</td>
<td>u</td>
<td>62</td>
<td>+</td>
</tr>
<tr>
<td>15</td>
<td>P</td>
<td>31</td>
<td>f</td>
<td>47</td>
<td>v</td>
<td>63</td>
<td>/</td>
</tr>
</table>




<!-- | 数值 | 字符 | 数值 | 字符 | 数值 | 字符 | 数值 | 字符 |
| - | - | | - | - | | - | - | | - | - |
| 0 | A | 16 | Q | 32 | g   | 48 | w |
| 1 | B | 17 | R | 33   | h | 49 | x |
| 2 |   C   | 18 | S | 34   | i | 50 | y |
| 3 | D | 19 | T | 35   | j | 51 | z |
| 4 | E | 20 | U | 36   | k | 52 | 0 |
| 5 |F  |21 |V  |37 |l  |53 |1
| 6 |G  |22 |W  |38 |m  |54 |2
| 7 |H  |23 |X  |39 |n  |55 |3
| 8 |I  |24 |Y  |40 |o  |56 |4
| 9 |J  |25 |Z  |41 |p  |57 |5
| 10    |K  |26 |a  |42 |q  |58 |6
| 11    |L  |27 |b  |43 |r  |59 |7
| 12    |M  |28 |c  |44 |s  |60 |8
| 13    |N  |29 |d  |45 |t  |61 |9
| 14    |O  |30 |e  |46 |u  |62 |+
| 15    |P  |31 |f  |47 |v  |63 |/ -->


<h4>5.一个简单的编码方法和译码方法实现：</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">base64Encode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="s1">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">binStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">newStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">threeChar</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">threeChar</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">j</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>      <span class="k">while</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="nx">t</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">t</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">binStr</span> <span class="o">+=</span> <span class="nx">t</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="nx">k</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">newStr</span> <span class="o">+=</span> <span class="nx">map</span><span class="p">[</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">binStr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">k</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="mi">2</span><span class="p">)];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="o">-</span><span class="nx">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">newStr</span> <span class="o">=</span> <span class="nx">newStr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="o">-</span><span class="nx">len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">newStr</span> <span class="o">=</span> <span class="nx">newStr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;==&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">out</span> <span class="o">+=</span> <span class="nx">newStr</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">base64Decode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="s1">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">ascii</span> <span class="o">=</span> <span class="s1">&#39; !&quot;#$%&amp;\&#39;()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span> <span class="o">+</span>
</span><span class='line'>          <span class="s1">&#39;[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">fourChar</span> <span class="o">=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">binStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">newStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">fourChar</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">j</span><span class="p">)).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>      <span class="k">while</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="nx">t</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">t</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">binStr</span> <span class="o">+=</span> <span class="nx">t</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="nx">k</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="kr">char</span> <span class="o">=</span> <span class="nx">ascii</span><span class="p">[</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">binStr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">k</span><span class="o">+</span><span class="mi">8</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">32</span><span class="p">];</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="kr">char</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">newStr</span> <span class="o">+=</span> <span class="kr">char</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">out</span> <span class="o">+=</span> <span class="nx">newStr</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h3>HTML5 提供的通用 Base64 方法 API</h3>

<h4>1.编码： <code>window.btoa(stringToEncode)</code></h4>

<p>只能将 ASCII 字符串或二进制数据转换成一个 base64 编码过的字符串,该方法不能直接作用于 Unicode 字符串。</p>

<h4>2.解码： <code>window.atob(encodedData)</code></h4>

<p>将已经被 base64 编码过的数据进行解码。</p>

<h4>3.作用于 UTF-8 编码的文字</h4>

<p>但是这两个 Web API 功能很简单，并不能直接作用于 Unicode 字符串，所以当调用 <code>btoa()</code> 时若传入的不是 ASCII 或二进制字符串，比如汉字就会出错。</p>

<p>下面是别人提供的简单解决方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">utf8_to_b64</span><span class="p">(</span> <span class="nx">str</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">btoa</span><span class="p">(</span><span class="nx">unescape</span><span class="p">(</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">str</span><span class="p">)));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">b64_to_utf8</span><span class="p">(</span> <span class="nx">str</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">atob</span><span class="p">(</span><span class="nx">str</span><span class="p">)));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>作者在这里使用了一个小小的Hack技巧。<code>encodeURIComponent()</code> 是ECMAscript中Global对象的URI方法，对URI进行编码，可以作用于所有Unicode字符。而 <code>escape()</code> 是已废弃的URI编码方法，功能和 <code>encodeURIComponent()</code> 相同，但是只能编码ASCII字符。</p>

<p>即 <code>encodeURIComponent(str)</code> 相当于 <code>escape(unicodeToASCII(str))</code> ，则 <code>unescape(encodeURIComponent(str))</code> 等同于 <code>unicodeToASCII(str)</code> ,所以就将 Unicode 字符转换成了 ASCII 字符。( <code>unescape()</code> 是和 <code>escape()</code> 对应的解码方法）</p>

<p>关于文字集和文字编码方面的知识，比如 UTF-8 是基于 Unicode 文字集的一种广泛使用的编码方式，具体此处不再赘述。</p>

<h3>Data URL与Base64</h3>

<p>这里主要说说 Data URL 模式和 Base64 ，比如下面这段代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\n\n\n%c&quot;</span><span class="p">,</span> <span class="s1">&#39;font-size:0;margin-top:20px;line-height:36px;padding-top:50px;padding-left:158px;background:url(&quot;data:image/png;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAAyAJ4DASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD3+iiigCtfX9vp1sZ7hwqjoO5PoK5afxu/mH7ParszwXPNc94y1sz6/Nbb/wB1a/IF/wBrqTXR+HvCls+nxXWoqZZZlDiPJAQHp+NerDD0aFFVK2rZ5U69avVdOi7JBa+NgXAurXap/ijOcV1Vtcw3kCzwOHjYcEVxnijwzBZae9/YBkEXMkecjHqM+lUvAest/ar6ezZjmQso9GH/ANalVw1KrRdahpbdDpV61KsqVbW56NRRRXlnqBRRVOTVtOhlaKW/tkkU4ZWlUEH6ZoAuUVQ/tvSv+glaf9/l/wAaP7b0r/oJWn/f5f8AGgC/RUMF1b3MXmwTxyxg43owI/On+dF/z1T/AL6FAD6Ko2utaXfSyRWmo2s8kX31jlVivbnBq2JYycCRCT2DUAPopjTRKcNIgI7FhSefD/z1j/76FAElFR+fD/z1j/76FPVlYZVgR6g0AMmmjgiaWVgqKMkmuO1fxrIkEj6YqkoM/vE+8O+DmqfxF1loJrXTVbarKZXHrzgf1qPwh4ei1iye8vdzW7MUSMHG7HXJ9K9COEgsM61XrscDxlT61GlSSdt76+p59qN1/al5LeyuUmmYu5XkE/SvY/CPiG01bRrePz4xdwxqksecHIGMgehrP174f6XdafIdMgFrdopMe1jtYjsQf5145E00krBJHh8s/PIpIK89OO5rzqVXE1akKFR8yb062PqcRh8sqYWri8PHklFXfS/6a7K3U9u8Zarbpo9xp6XCC4uF2HHOxT1OPXHQVwWivaaHex3lusktwgIDSvxzweBWVpkV1q1/DZWiPJK/djnA7lj/AFr1aw8FaTa2qx3EP2mbHzyOSMn2APFfQS9jgqfspNu58NH22Nqe0jpbb+u5X03xzaXEqxXqfZ2bgODlfx9K6tWDKGUgg8gjvXlPjbw+mgPDdWhY2kzFdpOSjdcZ9MfyrovhzrL6hpc9pKxZrVwFJ67T0rjxOFpuj9Yo7HZhsTUVb2Fbc7WvIfGeneCrHxNctq39q/bLj9+/kBSnPp+VevV4x8Q7yPT/AIlWN7NEZY4FikeMYywDZI5rzD0zjteHh3fCNAW82YPmm7xnPbGPxrVtE8AfY4RdnWWudg80xqu0t3xz0rr/APha+g/9C7P/AN8x1heLfHel+IdDaws9HktZTIr+YyoAAO3HNAHaWdlpln8Kb59HNx9juLeWZPPPzgng5x9K8tMOm2ehaddXEN9PcXRcsVm2oqq2MD3r1DS/+SKD/sHyfzauDll05vAWhWd9eS2rmea4jZITICAdv55NAEKweGAMjSPEYJ9HH/xNXvCUmjnxzYRQWGpxssuYzLPkqdp++uOn/wBaro8a6hHEMeJbsIqjBOkDGPrip/BmqaXL47+2y6pdX2pXymMAWnlr0HJ/BewoA6jXfhpYa9rNxqU2oXcckxGUTGBgAentWd/wp3S/+gpff+O/4Vk/FLRo9PuG1ganP9ovZQkdoowMBQCc59h27irWn/Cqa5063nudduoZ5I1d4wmdhIzjrQBc/wCFO6X/ANBS+/8AHf8ACuz8O6FD4c0aLTIJpJo42Zg8mMncSf61xDfCVI1LN4kulUdSY8Af+PV2nhjR00LQobCO8a8VGZhM3U5Yn1PTOKAPPvi1aSw6lYagobyniMRI6Bgcj8wT+VXPhv4stI9OOk3kgieNy0bN0IPJ/XNd9rGkWmuaZLY3ibo3HBHVT2I968h1T4c6zps5MEbXUIOUlhOG/EdQa9vD1KOJwyw9R2a2PHrwq4bEPEU48ye56jrPifT9M02a4FzG7Kp2lTkA9s/4d68HjE+pX0dpYwu7SSHy4x1Zj1J9z+lbsXg7xFqUqxta3bY6G4YhV9/mr0vwf4Kt/DUZuJmWfUJBhpMcIPRf8aqCw+Ai535p9CZzr49qmk4w3f8AWl/Is+EPCsPhrTsNiS+mAM8v/so9hXR0UV4tSpKpNzm9WevTpxpxUIrRGJ4p8Px+JNHNm85gdXEkcgGQGAI5HcYJqn4O8Jx+GLacm6+0zzkFnC4UAdABU3jKPVJNDzpUZmkSQNJEpwXTByB+ODj2rO8AW2tRWt3LqkUlvFI4MMEh5HqfbNdkef6o/f0vsccuT62vc1tudlXjnxAmay+JFjfG1knjt1ikZFX7wDZI6V7HRXAd55h/ws+w/wChXn/Jf/iawvFnjKDxFoh0+20Ga2kMiv5m0Hp24Fe2UUAcPZWlxb/B77NNDIk4sHBjK/Nzkjj8a4Sy1Oxi8H2+i6r4cvLtgXkSZPkaMlj904yOle50UAfPsmn+M5PDoR7fUjpAbiIjkL2+Xrj3xiuv8D6rpen6ha6dZeGb2Ga4bZJez/M3TOSccDjoMda9TooA8a8fX00/j+3M+n3FzY6dsxGgIEnRjzjvwPwrc/4WvL/0LN5/38/+xr0migDyPxF8QZ9c0C801fD95C1wm0SFydvPXG2ux+HFtcWngixjuYXikJdtrgg4LEg8+orq6KACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//Z&quot;);background-repeat:no-repeat;&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是一个真实的小例子，可以在百度网盘看到，会在控制台打印出百度云logo。这里用到了 <code>console.log()</code> 的一些稍微高级一点的用法，支持类似C语言 <code>printf()</code> 风格的打印方式，占位符 <code>%c</code> 可以使用一些CSS样式语句。比如这里使用的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">font-size</span><span class="o">:</span> <span class="nt">0</span><span class="o">;</span>
</span><span class='line'><span class="nt">margin-top</span><span class="o">:</span> <span class="nt">20px</span><span class="o">;</span>
</span><span class='line'><span class="nt">line-height</span><span class="o">:</span> <span class="nt">36px</span><span class="o">;</span>
</span><span class='line'><span class="nt">padding-top</span><span class="o">:</span> <span class="nt">50px</span><span class="o">;</span>
</span><span class='line'><span class="nt">padding-left</span><span class="o">:</span> <span class="nt">158px</span><span class="o">;</span>
</span><span class='line'><span class="nt">background</span><span class="o">:</span> <span class="nt">url</span><span class="o">(</span><span class="s2">&quot;data:image/png;base64...&quot;</span><span class="o">);</span>
</span><span class='line'><span class="nt">background-repeat</span><span class="o">:</span> <span class="nt">no-repeat</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>关于 <code>console.log()</code> 的用法以及 <code>console</code> 对象的其他方法、属性，具体此处不再赘述。</p>

<p>回到 url，可以看到一长串数据，在开头是这样的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">data</span><span class="nd">:image</span><span class="o">/</span><span class="nt">png</span><span class="o">;</span><span class="nt">base64</span><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>这就是 Data URL Scheme 的语法格式，后面是用 Base64 编码的图片数据。</p>

<p>完整的图片就像下面这样，可以直接复制到地址栏查看：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">data</span><span class="nd">:image</span><span class="o">/</span><span class="nt">png</span><span class="o">;</span><span class="nt">base64</span><span class="o">,/</span><span class="nt">9j</span><span class="o">/</span><span class="nt">4AAQSkZJRgABAQEAYABgAAD</span><span class="o">/</span><span class="nt">2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL</span><span class="o">/</span><span class="nt">2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL</span><span class="o">/</span><span class="nt">wAARCAAyAJ4DASIAAhEBAxEB</span><span class="o">/</span><span class="nt">8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL</span><span class="o">/</span><span class="nt">8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4</span><span class="o">+</span><span class="nt">Tl5ufo6erx8vP09fb3</span><span class="o">+</span><span class="nt">Pn6</span><span class="o">/</span><span class="nt">8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL</span><span class="o">/</span><span class="nt">8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3</span><span class="o">+</span><span class="nt">Pn6</span><span class="o">/</span><span class="nt">9oADAMBAAIRAxEAPwD3</span><span class="o">+</span><span class="nt">iiigCtfX9vp1sZ7hwqjoO5PoK5afxu</span><span class="o">/</span><span class="nt">mH7ParszwXPNc94y1sz6</span><span class="o">/</span><span class="nt">Nbb</span><span class="o">/</span><span class="nt">wB1a</span><span class="o">/</span><span class="nt">IF</span><span class="o">/</span><span class="nt">wBrqTXR</span><span class="o">+</span><span class="nt">HvCls</span><span class="o">+</span><span class="nt">nxXWoqZZZlDiPJAQHp</span><span class="o">+</span><span class="nt">NerDD0aFFVK2rZ5U69avVdOi7JBa</span><span class="o">+</span><span class="nt">NgXAurXap</span><span class="o">/</span><span class="nt">ijOcV1Vtcw3kCzwOHjYcEVxnijwzBZae9</span><span class="o">/</span><span class="nt">YBkEXMkecjHqM</span><span class="o">+</span><span class="nt">lUvAest</span><span class="o">/</span><span class="nt">ar6ezZjmQso9GH</span><span class="o">/</span><span class="nt">ANalVw1KrRdahpbdDpV61KsqVbW56NRRRXlnqBRRVOTVtOhlaKW</span><span class="o">/</span><span class="nt">tkkU4ZWlUEH6ZoAuUVQ</span><span class="o">/</span><span class="nt">tvSv</span><span class="o">+</span><span class="nt">glaf9</span><span class="o">/</span><span class="nt">l</span><span class="o">/</span><span class="nt">wAaP7b0r</span><span class="o">/</span><span class="nt">oJWn</span><span class="o">/</span><span class="nt">f5f8AGgC</span><span class="o">/</span><span class="nt">RUMF1b3MXmwTxyxg43owI</span><span class="o">/</span><span class="nt">On</span><span class="o">+</span><span class="nt">dF</span><span class="o">/</span><span class="nt">z1T</span><span class="o">/</span><span class="nt">AL6FAD6Ko2utaXfSyRWmo2s8kX31jlVivbnBq2JYycCRCT2DUAPopjTRKcNIgI7FhSefD</span><span class="o">/</span><span class="nt">z1j</span><span class="o">/</span><span class="nt">76FAElFR</span><span class="o">+</span><span class="nt">fD</span><span class="o">/</span><span class="nt">z1j</span><span class="o">/</span><span class="nt">76FPVlYZVgR6g0AMmmjgiaWVgqKMkmuO1fxrIkEj6YqkoM</span><span class="o">/</span><span class="nt">vE</span><span class="o">+</span><span class="nt">8O</span><span class="o">+</span><span class="nt">DmqfxF1loJrXTVbarKZXHrzgf1qPwh4ei1iye8vdzW7MUSMHG7HXJ9K9COEgsM61XrscDxlT61GlSSdt76</span><span class="o">+</span><span class="nt">p59qN1</span><span class="o">/</span><span class="nt">al5LeyuUmmYu5XkE</span><span class="o">/</span><span class="nt">SvY</span><span class="o">/</span><span class="nt">CPiG01bRrePz4xdwxqksecHIGMgehrP174f6XdafIdMgFrdopMe1jtYjsQf5145E00krBJHh8s</span><span class="o">/</span><span class="nt">PIpIK89OO5rzqVXE1akKFR8yb062PqcRh8sqYWri8PHklFXfS</span><span class="o">/</span><span class="nt">6a7K3U9u8Zarbpo9xp6XCC4uF2HHOxT1OPXHQVwWivaaHex3lusktwgIDSvxzweBWVpkV1q1</span><span class="o">/</span><span class="nt">DZWiPJK</span><span class="o">/</span><span class="nt">djnA7lj</span><span class="o">/</span><span class="nt">AFr1aw8FaTa2qx3EP2mbHzyOSMn2APFfQS9jgqfspNu58NH22Nqe0jpbb</span><span class="o">+</span><span class="nt">u5X03xzaXEqxXqfZ2bgODlfx9K6tWDKGUgg8gjvXlPjbw</span><span class="o">+</span><span class="nt">mgPDdWhY2kzFdpOSjdcZ9MfyrovhzrL6hpc9pKxZrVwFJ67T0rjxOFpuj9Yo7HZhsTUVb2Fbc7WvIfGeneCrHxNctq39q</span><span class="o">/</span><span class="nt">bLj9</span><span class="o">+/</span><span class="nt">kBSnPp</span><span class="o">+</span><span class="nt">VevV4x8Q7yPT</span><span class="o">/</span><span class="nt">AIlWN7NEZY4FikeMYywDZI5rzD0zjteHh3fCNAW82YPmm7xnPbGPxrVtE8AfY4RdnWWudg80xqu0t3xz0rr</span><span class="o">/</span><span class="nt">APha</span><span class="o">+</span><span class="nt">g</span><span class="o">/</span><span class="nt">9C7P</span><span class="o">/</span><span class="nt">AN8x1heLfHel</span><span class="o">+</span><span class="nt">IdDaws9HktZTIr</span><span class="o">+</span><span class="nt">YyoAAO3HNAHaWdlpln8Kb59HNx9juLeWZPPPzgng5x9K8tMOm2ehaddXEN9PcXRcsVm2oqq2MD3r1DS</span><span class="o">/+</span><span class="nt">SKD</span><span class="o">/</span><span class="nt">sHyfzauDll05vAWhWd9eS2rmea4jZITICAdv55NAEKweGAMjSPEYJ9HH</span><span class="o">/</span><span class="nt">xNXvCUmjnxzYRQWGpxssuYzLPkqdp</span><span class="o">++</span><span class="nt">uOn</span><span class="o">/</span><span class="nt">wBaro8a6hHEMeJbsIqjBOkDGPrip</span><span class="o">/</span><span class="nt">BmqaXL47</span><span class="o">+</span><span class="nt">2y6pdX2pXymMAWnlr0HJ</span><span class="o">/</span><span class="nt">BewoA6jXfhpYa9rNxqU2oXcckxGUTGBgAentWd</span><span class="o">/</span><span class="nt">wp3S</span><span class="o">/+</span><span class="nt">gpff</span><span class="o">+</span><span class="nt">O</span><span class="o">/</span><span class="nt">4Vk</span><span class="o">/</span><span class="nt">FLRo9PuG1ganP9ovZQkdoowMBQCc59h27irWn</span><span class="o">/</span><span class="nt">Cqa5063nudduoZ5I1d4wmdhIzjrQBc</span><span class="o">/</span><span class="nt">wCFO6X</span><span class="o">/</span><span class="nt">ANBS</span><span class="o">+/</span><span class="nt">8AHf8ACuz8O6FD4c0aLTIJpJo42Zg8mMncSf61xDfCVI1LN4kulUdSY8Af</span><span class="o">+</span><span class="nt">PV2nhjR00LQobCO8a8VGZhM3U5Yn1PTOKAPPvi1aSw6lYagobyniMRI6Bgcj8wT</span><span class="o">+</span><span class="nt">VXPhv4stI9OOk3kgieNy0bN0IPJ</span><span class="o">/</span><span class="nt">XNd9rGkWmuaZLY3ibo3HBHVT2I968h1T4c6zps5MEbXUIOUlhOG</span><span class="o">/</span><span class="nt">EdQa9vD1KOJwyw9R2a2PHrwq4bEPEU48ye56jrPifT9M02a4FzG7Kp2lTkA9s</span><span class="o">/</span><span class="nt">4d68HjE</span><span class="o">+</span><span class="nt">pX0dpYwu7SSHy4x1Zj1J9z</span><span class="o">+</span><span class="nt">lbsXg7xFqUqxta3bY6G4YhV9</span><span class="o">/</span><span class="nt">mr0vwf4Kt</span><span class="o">/</span><span class="nt">DUZuJmWfUJBhpMcIPRf8aqCw</span><span class="o">+</span><span class="nt">Ai535p9CZzr49qmk4w3f8AWl</span><span class="o">/</span><span class="nt">Is</span><span class="o">+</span><span class="nt">EPCsPhrTsNiS</span><span class="o">+</span><span class="nt">mAM8v</span><span class="o">/</span><span class="nt">so9hXR0UV4tSpKpNzm9WevTpxpxUIrRGJ4p8Px</span><span class="o">+</span><span class="nt">JNHNm85gdXEkcgGQGAI5HcYJqn4O8Jx</span><span class="o">+</span><span class="nt">GLacm6</span><span class="o">+</span><span class="nt">0zzkFnC4UAdABU3jKPVJNDzpUZmkSQNJEpwXTByB</span><span class="o">+</span><span class="nt">ODj2rO8AW2tRWt3LqkUlvFI4MMEh5HqfbNdkef6o</span><span class="o">/</span><span class="nt">f0vsccuT62vc1tudlXjnxAmay</span><span class="o">+</span><span class="nt">JFjfG1knjt1ikZFX7wDZI6V7HRXAd55h</span><span class="o">/</span><span class="nt">ws</span><span class="o">+</span><span class="nt">w</span><span class="o">/</span><span class="nt">wChXn</span><span class="o">/</span><span class="nt">Jf</span><span class="o">/</span><span class="nt">iawvFnjKDxFoh0</span><span class="o">+</span><span class="nt">20Ga2kMiv5m0Hp24Fe2UUAcPZWlxb</span><span class="o">/</span><span class="nt">B77NNDIk4sHBjK</span><span class="o">/</span><span class="nt">Nzkjj8a4Sy1Oxi8H2</span><span class="o">+</span><span class="nt">i6r4cvLtgXkSZPkaMlj904yOle50UAfPsmn</span><span class="o">+</span><span class="nt">M5PDoR7fUjpAbiIjkL2</span><span class="o">+</span><span class="nt">Xrj3xiuv8D6rpen6ha6dZeGb2Ga4bZJez</span><span class="o">/</span><span class="nt">M3TOSccDjoMda9TooA8a8fX00</span><span class="o">/</span><span class="nt">j</span><span class="o">+</span><span class="nt">3M</span><span class="o">+</span><span class="nt">n3FzY6dsxGgIEnRjzjvwPwrc</span><span class="o">/</span><span class="nt">4WvL</span><span class="o">/</span><span class="nt">0LN5</span><span class="o">/</span><span class="nt">38</span><span class="o">/+</span><span class="nt">xr0migDyPxF8QZ9c0C801fD95C1wm0SFydvPXG2ux</span><span class="o">+</span><span class="nt">HFtcWngixjuYXikJdtrgg4LEg8</span><span class="o">+</span><span class="nt">orq6KACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD</span><span class="o">//</span><span class="nt">Z</span>
</span></code></pre></td></tr></table></div></figure>


<p>不过，Firefox 似乎不支持在控制台使用 Data URL，大概是由于这个原因，有时候可以降级在控制台直接使用一张图片。</p>

<h5>参考资料：</h5>

<ol>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window.btoa">https://developer.mozilla.org/zh-CN/docs/Web/API/Window.btoa</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window.atob">https://developer.mozilla.org/zh-CN/docs/Web/API/Window.atob</a></li>
<li><a href="http://tools.ietf.org/html/rfc2397" title="RFC 2397 of the Internet Engineering Task Force (IETF)">RFC 2397 of the Internet Engineering Task Force (IETF)</a></li>
<li>Javascript高级程序设计（第3版）[人民邮电出版社]</li>
<li>Java加密与解密的艺术[机械工业出版社]</li>
</ol>

]]></content>
  </entry>
  
</feed>
